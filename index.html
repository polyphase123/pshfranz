<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSH WESM Simulator | DOE & ERC Supplemental Policy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #eff6ff;
            --success: #10b981;
            --success-light: #ecfdf5;
            --warning: #f59e0b;
            --warning-light: #fffbeb;
            --danger: #ef4444;
            --danger-light: #fef2f2;
            --text-dark: #0f172a;
            --text-muted: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-dark);
            line-height: 1.5;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3 {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: stretch;
                gap: 1.5rem;
            }
        }

        .logo-section h1 {
            font-size: 1.75rem;
            background: linear-gradient(135deg, #1e293b 0%, #2563eb 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-section p {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card .label {
            font-size: 0.8125rem;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .stat-card .info-trigger {
            cursor: help;
            color: var(--primary);
            font-size: 0.75rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #pshChartContainer {
            height: 400px;
            width: 100%;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            justify-content: flex-end;
        }

        button {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
        }

        .primary-btn:hover {
            background: #1d4ed8;
        }

        .secondary-btn {
            background: var(--primary-light);
            color: var(--primary);
        }

        .secondary-btn:hover {
            background: #dbeafe;
        }

        .year-pill {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            background: #f1f5f9;
            color: var(--text-muted);
            cursor: pointer;
            border: 1px solid transparent;
        }

        .year-pill.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }

        .year-selector {
            display: flex;
            gap: 0.25rem;
            flex-wrap: nowrap;
        }

        .reservoir-visual {
            height: 200px;
            background: #f8fafc;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
            border: 2px solid var(--border-color);
        }

        .water {
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            width: 100%;
            transition: height 0.5s ease-in-out;
            position: relative;
        }

        .water::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            filter: blur(4px);
        }

        .reservoir-labels {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
            z-index: 10;
            pointer-events: none;
        }

        .res-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .settlement-table {
            width: 100%;
            border-collapse: collapse;
        }

        .settlement-table th {
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settlement-table td {
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .settlement-table .total-row {
            font-weight: 700;
            border-top: 2px solid var(--border-color);
        }

        /* Tooltip style */
        .popup-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            max-width: 600px;
            width: 90%;
            border: 1px solid var(--border-color);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-citation {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .feature-badge {
            background: var(--success-light);
            color: var(--success);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .erc-feature {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary);
        }

        .erc-feature h4 {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .selection-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            background: #ffffff;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 1.25rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04);
            border-top: 4px solid var(--primary);
            align-items: start;
        }

        .selection-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border-right: 1px solid #f1f5f9;
            padding-right: 1.25rem;
        }

        .selection-item:last-child {
            border-right: none;
            padding-right: 0;
        }

        .selection-item .label {
            font-size: 0.6rem;
            color: #64748b;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .selection-item .value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1.3;
        }

        .chart-res-grid {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 1200px) {
            .chart-res-grid {
                grid-template-columns: 1fr;
            }
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: #f1f5f9;
            padding: 0.5rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            border-radius: 0.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr !important;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .selection-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        .calc-basis-btn {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s;
        }

        .calc-basis-btn:hover {
            background: var(--primary-light);
        }



        .audit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .audit-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .selection-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.25rem;
                padding: 1.5rem;
            }

            .selection-item {
                width: 100%;
                border-bottom: 1px solid #f1f5f9;
                padding-bottom: 0.75rem;
            }

            .selection-item:last-child {
                border-bottom: none;
            }
        }

        .audit-card {
            background: #f8fafc;
            padding: 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .audit-card h4 {
            font-size: 0.8125rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .audit-card .val {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .footer-credit {
            margin-top: 3rem;
            text-align: center;
            font-size: 0.75rem;
            color: #fca5a5;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        @media (max-width: 1024px) {
            .audit-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .audit-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <div class="modal-overlay" id="overlay"></div>
    <div class="popup-modal" id="modal">
        <span class="modal-close" onclick="closeModal()">‚úï</span>
        <div class="modal-header">
            <div class="modal-citation" id="modalCitation"></div>
            <h2 id="modalTitle"></h2>
        </div>
        <div id="modalBody" style="font-size: 0.95rem; color: #4b5563;"></div>
    </div>



    <div class="container">
        <header>
            <div class="logo-section">
                <h1>GEA3 Settle Mechanism Simulator</h1>
                <p style="color: #2563eb; font-weight: 700; font-size: 1rem; margin-top: 0.25rem;">Franz Xyrlo I.
                    Tobias, PEE</p>
                <p style="font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.7; color: var(--text-muted);">
                    (OGCS-PROM+1623-2025 ANNEX B / Non-FIT GEAP)</p>
            </div>
            <div id="pshHeaderControls" class="controls">
                <div class="year-selector">
                    <span class="year-pill active" onclick="setYear(2025)">2025 (3.81)</span>
                    <span class="year-pill" onclick="setYear(2024)">2024 (4.99)</span>
                    <span class="year-pill" onclick="setYear(2023)">2023 (5.96)</span>
                    <span class="year-pill" onclick="setYear(2022)">2022 (7.42)</span>
                </div>
                <select id="plantSelect" onchange="updatePlant()"
                    style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-family: 'Inter'; font-size: 0.875rem; background: white;">
                    <optgroup label="GEA3 (2028-2030)">
                        <option value="kibungan">Kibungan PSH (Coheco) - 500MW</option>
                        <option value="wawa1">Wawa PSH 1 (Olympia) - 600MW</option>
                        <option value="pakil">Pakil PSH (Ahunan) - 1400MW</option>
                    </optgroup>
                    <optgroup label="GEA3 (2031-2035)">
                        <option value="sr_lower">SR Lower East (San Roque) - 800MW</option>
                        <option value="sr_west">SR West (San Roque) - 800MW</option>
                        <option value="maton">Maton PSH (Pan Pacific) - 2000MW</option>
                        <option value="aklan">Aklan PSH (San Roque) - 250MW</option>
                    </optgroup>
                </select>
                <button class="primary-btn" id="playBtn" onclick="toggleSim()">Run 5-Min Cycle</button>
                <button class="secondary-btn" onclick="resetSim()">Reset</button>
                <div
                    style="display:flex; gap:0.5rem; margin-left:1rem; border-left: 1px solid var(--border-color); padding-left:1rem;">
                    <button class="secondary-btn"
                        onclick="document.getElementById('fileUpload').click(); return false;">üìÇ Load JSON</button>
                    <input type="file" id="fileUpload" style="display:none" accept=".json"
                        onchange="loadScenario(event)" />
                    <button class="secondary-btn" onclick="saveScenario()">üíæ Save JSON</button>
                </div>
            </div>
        </header>

        <div id="pshSelectionBar" class="selection-bar">
            <div class="selection-item">
                <div class="label">üè¢ RE Developer</div>
                <div class="value" id="selDeveloper">-</div>
            </div>
            <div class="selection-item">
                <div class="label">‚ö° RE Facility Name</div>
                <div class="value" id="selFacility">-</div>
            </div>
            <div class="selection-item">
                <div class="label">üè∑Ô∏è GEA3 Lot</div>
                <div class="value" id="selLot">-</div>
            </div>
            <div class="selection-item">
                <div class="label">üí∞ Non-FIT GEAP Price</div>
                <div class="value" id="selPrice">-</div>
            </div>
            <div class="selection-item">
                <div class="label">‚öôÔ∏è Engineering Configuration</div>
                <div class="value" id="selConfig">-</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('simulator')">PSH Simulator</div>
            <div class="tab" onclick="switchTab('geothermal')">GEA3 Geothermal</div>
            <div class="tab" onclick="switchTab('impounding')">GEA3 Impounding Hydro</div>
            <div class="tab" onclick="switchTab('suppression')">WESM Price Suppression</div>
            <div class="tab" onclick="switchTab('wesmdata')">WESM Data (GWAP/LWAP)</div>
            <div class="tab" onclick="switchTab('audit')">ERC Regulatory Audit</div>
        </div>

        <div id="simulator" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">WESM Price <span class="info-trigger" onclick="showInfo('wesm_price')">‚ìò</span>
                    </div>
                    <div class="value" id="currentPrice">‚Ç±4.50<small>/kWh</small></div>
                    <div id="priceTrend" style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--success);">Annual
                        Average WESM</div>
                </div>
                <div class="stat-card">
                    <div class="label">Current Dispatch <span class="info-trigger"
                            onclick="showInfo('dispatch')">‚ìò</span>
                    </div>
                    <div class="value" id="currentDispatch">0 MW</div>
                    <div id="dispatchMode" class="feature-badge"
                        style="margin-top: 0.25rem; background: #f1f5f9; color: #64748b;">STANDBY</div>
                </div>
                <div class="stat-card">
                    <div class="label">Potential Rate Impact <span class="info-trigger"
                            onclick="showInfo('rate_impact')">‚ìò</span>
                    </div>
                    <div class="value" id="rateImpact">‚Ç±0.0000<small>/kWh</small></div>
                    <div id="verdictBadge" class="feature-badge"
                        style="margin-top: 0.25rem; background: #f1f5f9; color: #64748b;">NEUTRAL</div>
                </div>
                <div class="stat-card">
                    <div class="label">Net Settlement <span class="info-trigger"
                            onclick="showInfo('settlement')">‚ìò</span>
                    </div>
                    <div class="value" id="netSettlement">‚Ç±0.00</div>
                    <div id="settlementStatus"
                        style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-muted);">
                        Day-Ahead Projection</div>
                </div>
            </div>

            <!-- PSH TAB DERATING CONTROL -->
            <div class="card" style="margin-bottom: 2rem; border-left: 4px solid var(--warning);">
                <div style="padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <span
                            style="font-size: 0.75rem; font-weight: 700; color: var(--text-color); display: flex; align-items: center; gap: 0.5rem;">
                            ‚ö†Ô∏è DERATING STRESSOR: Capacity Availability (%)
                        </span>
                        <input type="range" min="0" max="100" step="1" value="100" id="slideDerateTab"
                            style="width: 100%; margin-top: 0.5rem;" oninput="updateStressParam('derate', this.value)">
                    </div>
                    <div style="margin-left: 2rem; text-align: right;">
                        <div id="valDerateTab" style="font-size: 1.25rem; font-weight: 800; color: var(--warning);">100%
                        </div>
                        <div style="font-size: 0.6rem; color: var(--text-muted);">CURRENT PMAX ALLOWANCE</div>
                    </div>
                </div>
            </div>

            <div class="main-grid">
                <div class="left-col">
                    <div class="chart-res-grid">
                        <div class="card" style="margin-bottom: 0;">
                            <div class="card-header">
                                <div class="card-title">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                                    </svg>
                                    Real-Time 5-Minute Market Activity
                                </div>
                                <div id="simTime" style="font-weight: 600; color: var(--primary);">00:00 H</div>
                            </div>
                            <div id="pshChartContainer">
                                <canvas id="pshChart"></canvas>
                            </div>
                        </div>

                        <div class="card" style="margin-bottom: 0;">
                            <div class="card-header">
                                <div class="card-title">Reservoir Status</div>
                                <div class="feature-badge" id="waterPct">50%</div>
                            </div>
                            <div class="reservoir-visual" style="height: 380px;">
                                <div class="water" id="waterLevel" style="height: 50%;"></div>
                                <div class="reservoir-labels">
                                    <div class="res-label">Upper Reservoir (100%)</div>
                                    <div class="res-label" style="border-top: 1px dashed #cbd5e1; padding-top: 2px;">
                                        Standard
                                        Level</div>
                                    <div class="res-label">Lower Reservoir (0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Detailed Methodology & Citations</div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-dark);">
                            <div style="margin-bottom: 1rem;">
                                <strong>1. Settlement Formula (OGCS-PROM+1623-2025 Annex B):</strong><br>
                                <code>Total GEA = Œ£ (|AC·µ¢| √ó GET √ó d·µ¢)</code><br>
                                <small>Where AC=Available Capacity(kW), GET=Bidding Rate(PhP/kW/h),
                                    d=Duration(h)</small>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <strong>2. Consumer Rate Impact Formula:</strong><br>
                                <code>Impact (PhP/kWh) = (GEA_Payment - [EnergyRevenue - PumpingCost] - AS_Revenue) / SystemDemand</code><br>
                                <small>System-wide impact is socialized across all metered customers per Sec 8.2 of
                                    Supplemental Policy.</small>
                            </div>
                            <div style="background: #f1f5f9; padding: 0.75rem; border-radius: 0.5rem;">
                                <strong>WESM Price Data Sources (Annual GWAP):</strong>
                                <div style="font-family: monospace; font-size: 0.7rem; margin-top: 0.25rem;">
                                    2025: ‚Ç±3.81/kWh (GWAP Jan-Feb YTD)<br>
                                    2024: ‚Ç±4.99/kWh (GWAP Annual Average)<br>
                                    2023: ‚Ç±5.96/kWh (GWAP Annual Average)<br>
                                    2022: ‚Ç±7.42/kWh (GWAP Annual Average)
                                </div>
                                <hr style="margin: 0.5rem 0; border: 0; border-top: 1px solid #cbd5e1;">
                                <strong>Source Reference Documents:</strong>
                                <ul style="margin-top: 0.1rem; padding-left: 1.25rem; font-size: 0.75rem;">
                                    <li><strong>OGCS-PROM+1623-2025 Annex B:</strong> Non-FIT GEAP Settlement</li>
                                    <li><strong>DC2023-10-0029:</strong> PSH & KPSPP Policy</li>
                                    <li><strong>IEMOP Reports:</strong> 2022-2024 Market Data</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Summary: All PSH Plants Rate Impact Comparison</div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="settlement-table" style="font-size: 0.8rem;">
                                <thead>
                                    <tr>
                                        <th>Lot</th>
                                        <th>Facility Name</th>
                                        <th>Capacity</th>
                                        <th>GEAP Rate</th>
                                        <th style="text-align: right;">Est. Rate Impact*</th>
                                    </tr>
                                </thead>
                                <tbody id="plantTableBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem;">
                                *Projected monthly socialized charge per metered kWh based on current year market
                                averages.
                            </p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">20-Year Grid Impact Roadmap (Projected)</div>
                        </div>
                        <div style="padding: 1rem;">
                            <canvas id="roadmapChart"
                                style="height: 250px; width: 100%; margin-bottom: 1.5rem;"></canvas>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="settlement-table" style="font-size: 0.75rem;">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th style="color:#2563eb">PSH (‚Ç±)</th>
                                        <th style="color:#8b5cf6">GEO (‚Ç±)</th>
                                        <th style="color:#0ea5e9">HYD (‚Ç±)</th>
                                        <th style="text-align: right;">Total (‚Ç±)</th>
                                    </tr>
                                </thead>
                                <tbody id="roadmapTableBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.75rem;">
                                **Estimated socialized charge considering the phased addition of Lot 1, 2, and 3 plants.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="right-col">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Consumer Impact Summary</div>
                        </div>
                        <div id="consumerVerdictCard"
                            style="padding: 1rem; border-radius: 0.75rem; background: var(--primary-light); border: 1px solid var(--primary); transition: all 0.3s ease;">
                            <h3 id="verdictTitle" style="color: var(--primary); margin-bottom: 0.5rem;">Awaiting
                                Simulation...</h3>
                            <p id="verdictBody" style="font-size: 0.875rem; color: var(--text-dark);">
                                Click "Run 5-Min Cycle" to analyze how the current PSH settlement affects consumer
                                electricity rates.
                            </p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Life-Cycle Settlement Projection</div>
                        </div>
                        <table class="settlement-table" style="font-size: 0.85rem;">
                            <tbody id="projectionTable">
                                <tr>
                                    <td>Daily Impact</td>
                                    <td style="text-align: right;" id="projDaily">‚Ç±0.00</td>
                                </tr>
                                <tr>
                                    <td>Monthly Settlement</td>
                                    <td style="text-align: right;" id="projMonthly">‚Ç±0.00</td>
                                </tr>
                                <tr>
                                    <td>Annual Settlement</td>
                                    <td style="text-align: right;" id="projAnnual">‚Ç±0.00</td>
                                </tr>
                                <tr class="total-row">
                                    <td>20-Year Lifecycle</td>
                                    <td style="text-align: right; color: var(--primary);" id="proj20Year">‚Ç±0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Settlement Breakdown</div>
                        </div>
                        <table class="settlement-table">
                            <tbody>
                                <tr>
                                    <td>Capacity Payment (GEA)</td>
                                    <td style="text-align: right;" id="breakdownGEA">‚Ç±0.00</td>
                                </tr>
                                <tr>
                                    <td>Energy Trading (Injection)</td>
                                    <td style="text-align: right;" id="breakdownEnergy">‚Ç±0.00</td>
                                </tr>
                                <tr>
                                    <td>Pumping Cost (Deduction)</td>
                                    <td style="text-align: right; color: var(--danger);" id="breakdownPumping">(‚Ç±0.00)
                                    </td>
                                </tr>
                                <tr>
                                    <td>Ancillary Services (AS)</td>
                                    <td style="text-align: right;" id="breakdownAS">‚Ç±0.00</td>
                                </tr>
                                <tr class="total-row">
                                    <td>TOTAL NET SETTLEMENT</td>
                                    <td style="text-align: right; color: var(--primary);" id="breakdownTotal">‚Ç±0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card" style="border-left: 4px solid var(--primary);">
                        <div class="card-header">
                            <div class="card-title">üìú DOE DC2024-01-0003 Provisions</div>
                        </div>
                        <div style="font-size: 0.75rem; line-height: 1.5; color: var(--text-dark);">
                            <div style="margin-bottom: 0.75rem;"><strong>Sec 3.1:</strong> GEA PSH shall receive
                                Capacity Payments for 24/7 availability.</div>
                            <div style="margin-bottom: 0.75rem;"><strong>Sec 4.2:</strong> Energy settlement via Market
                                Operator using Net-Settlement mechanism.</div>
                            <div style="margin-bottom: 0.75rem;"><strong>Sec 5.1:</strong> Mandatory 75% physical RTE
                                for full cost recovery.</div>
                            <div style="margin-bottom: 0.75rem;"><strong>Sec 6.3:</strong> Priority Grid Security
                                dispatch during N-1 contingencies.</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üõ∞Ô∏è Policy Enforcement Log</div>
                        </div>
                        <div id="policyLog"
                            style="height: 250px; overflow-y: auto; font-family: monospace; font-size: 0.65rem; background: #0f172a; color: #38bdf8; padding: 0.75rem; border-radius: 0.5rem; line-height: 1.4;">
                            <div style="color: #94a3b8;">[SYSTEM] Awaiting Simulation start...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- Close main-grid -->
    </div><!-- Close simulator tab -->

    <div id="wesmdata" class="tab-content" style="display: none; padding: 2rem 0;">
        <div class="card" style="border-top: 4px solid var(--primary); margin-bottom: 2rem;">
            <div class="card-header">
                <div class="card-title" style="color: var(--primary); font-weight: 800;">üìä IEMOP WESM Data (GWAP &
                    LWAP)</div>
                <div class="feature-badge" style="background: #e0f2fe; color: #0369a1;">Verified Market Benchmarks</div>
            </div>
            <div style="padding: 1.5rem;">
                <p
                    style="font-size: 0.8125rem; color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.5; border-left: 3px solid var(--primary); padding-left: 0.75rem;">
                    The simulation engine relies on the official Generation Weighted Average Price (GWAP) and Load
                    Weighted Average Price (LWAP) extracted from IEMOP dataset (2022-2025). These annual benchmarks form
                    the baseline for projecting the 15-minute generation, pumping, and settlement algorithms across all
                    GEA3 asset classes.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color:var(--text-dark); margin-bottom: 0.75rem;">Historical GWAP (Generation)</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead>
                                <tr
                                    style="border-bottom: 2px solid var(--border-color); text-align: left; color: var(--text-muted);">
                                    <th style="padding: 0.5rem;">Year</th>
                                    <th style="padding: 0.5rem; text-align: right;">National GWAP (‚Ç±/kWh)</th>
                                    <th style="padding: 0.5rem; text-align: right;">YoY Variance</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.5rem; font-weight:700;">2025 (YTD)</td>
                                    <td
                                        style="padding: 0.5rem; text-align: right; color:var(--primary); font-weight:700;">
                                        ‚Ç±3.815</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--success);">-23.6%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.5rem; font-weight:700;">2024</td>
                                    <td
                                        style="padding: 0.5rem; text-align: right; color:var(--primary); font-weight:700;">
                                        ‚Ç±4.992</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--success);">-16.2%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.5rem; font-weight:700;">2023</td>
                                    <td
                                        style="padding: 0.5rem; text-align: right; color:var(--primary); font-weight:700;">
                                        ‚Ç±5.955</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--success);">-19.7%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; font-weight:700;">2022</td>
                                    <td
                                        style="padding: 0.5rem; text-align: right; color:var(--danger); font-weight:700;">
                                        ‚Ç±7.421</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--text-muted);">Baseline
                                        (Fuel Crisis)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4 style="color:var(--text-dark); margin-bottom: 0.75rem;">Historical LWAP (Load Context)</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead>
                                <tr
                                    style="border-bottom: 2px solid var(--border-color); text-align: left; color: var(--text-muted);">
                                    <th style="padding: 0.5rem;">Year</th>
                                    <th style="padding: 0.5rem; text-align: right;">National LWAP (‚Ç±/kWh)</th>
                                    <th style="padding: 0.5rem; text-align: right;">Line Loss Delta</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.5rem; font-weight:700;">2025 (YTD)</td>
                                    <td style="padding: 0.5rem; text-align: right; font-weight:700;">‚Ç±4.314</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--warning);">+‚Ç±0.499</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.5rem; font-weight:700;">2024</td>
                                    <td style="padding: 0.5rem; text-align: right; font-weight:700;">‚Ç±5.424</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--warning);">+‚Ç±0.432</td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.5rem; font-weight:700;">2023</td>
                                    <td style="padding: 0.5rem; text-align: right; font-weight:700;">‚Ç±6.378</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--warning);">+‚Ç±0.423</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.5rem; font-weight:700;">2022</td>
                                    <td style="padding: 0.5rem; text-align: right; font-weight:700;">‚Ç±7.815</td>
                                    <td style="padding: 0.5rem; text-align: right; color:var(--warning);">+‚Ç±0.394</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div
                    style="margin-top: 2rem; background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border-color);">
                    <h4 style="color:#1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">üßÆ
                        Engine Calculation Methodology</h4>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
                        <div
                            style="background: white; padding: 1.25rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <h5
                                style="color:var(--primary); font-size:0.8rem; margin-bottom: 0.5rem; text-transform: uppercase;">
                                1. The WESM Reference Vector</h5>
                            <p
                                style="font-size:0.75rem; color:var(--text-muted); line-height: 1.5; margin-bottom: 0.5rem;">
                                The simulator natively utilizes the <strong>National Average GWAP</strong> to construct
                                the baseline price (<code>avgPrice</code>). GWAP was chosen over LWAP as it reflects the
                                true clearing price at the generator's node, eliminating demand-side transmission loss
                                biases that are not settled by the generating unit.
                            </p>
                            <code
                                style="font-size:0.7rem; background:#f1f5f9; padding:0.4rem; display:block; border-radius:0.25rem;">let avgPrice = HISTORICAL_PRICES[selectedYear] * marketPriceScalar;</code>
                        </div>

                        <div
                            style="background: white; padding: 1.25rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <h5
                                style="color:var(--success); font-size:0.8rem; margin-bottom: 0.5rem; text-transform: uppercase;">
                                2. Stochastic 15-Minute Market Generation (Simulation)</h5>
                            <p
                                style="font-size:0.75rem; color:var(--text-muted); line-height: 1.5; margin-bottom: 0.5rem;">
                                Market interval prices are extrapolated using a <strong>Sinusoidal Time-of-Day (TOD)
                                    Engine</strong> bounded by an external <strong>Volatility Constant (œÉ)</strong>. The
                                base calculation ensures that the mathematical average across the 96 daily trading
                                intervals converges on the elected GWAP benchmark, while capturing peak/off-peak
                                arbitrage spreads.
                            </p>
                            <code
                                style="font-size:0.7rem; background:#f1f5f9; padding:0.4rem; display:block; border-radius:0.25rem;">
                                // 'todFactor' produces a multi-peak curve mimicking demand (Noon & 7 PM surges).<br>
                                const todFactor = Math.sin((currentInterval / 96) * Math.PI * 2) * 0.5 + 0.5; <br>
                                // Stochastic derivation<br>
                                const currentPrice = avgPrice * (1 + (todFactor * volatility * 0.5));
                            </code>
                        </div>

                        <div
                            style="background: white; padding: 1.25rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <h5
                                style="color:var(--danger); font-size:0.8rem; margin-bottom: 0.5rem; text-transform: uppercase;">
                                3. Avoided Peaker Costs & Rate Impact Calculus</h5>
                            <p
                                style="font-size:0.75rem; color:var(--text-muted); line-height: 1.5; margin-bottom: 0.5rem;">
                                The <strong>Rate Impact (RI)</strong> calculation projects 20-year consumer mitigation.
                                It assumes that PSH displaces diesel units (peakers). The formula relies on
                                <code>pumpPrice</code> (GWAP discounted by 20-30% off-peak) against
                                <code>injPrice</code> (GWAP amplified to simulate peak dispatch scarcity).
                            </p>
                            <code
                                style="font-size:0.7rem; background:#f1f5f9; padding:0.4rem; display:block; border-radius:0.25rem;">
                                const pumpPrice = avgPrice * 0.7 * (1 / volatility); <br>
                                const injPrice = avgPrice * (zonalLMPActive ? 1.5 : 1.3); <br>
                                // Rate Impact mitigates Total Cost per DOE Policy<br>
                                const geaPayment = Capacity * Bidding_GET * Hours;<br>
                                const riSubTotal = geaPayment - (injPriceRev - pumpPriceCost) - asRevenue;<br>
                                Rate_Impact = Max(0, riSubTotal) / System_Demand_MWh;
                            </code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="audit" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <div class="card-title">üîç ERC Advanced Regulatory Compliance Metrics</div>
            </div>
            <div class="audit-grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                <!-- SECTION: PSH CORE AUDITS -->
                <div
                    style="grid-column: span 4; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5
                        style="font-size: 0.75rem; text-transform: uppercase; color: #2563eb; letter-spacing: 0.05em; font-weight: 800;">
                        üõ∞Ô∏è PSH Settlement & Operational Core</h5>
                    <span
                        style="font-size: 0.6rem; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 700;">DC2024-01-0003
                        Compliance</span>
                </div>
                <div class="audit-card">
                    <h4>01. RTE Compliance (75% Rule)</h4>
                    <div class="val" id="auditRTE" style="color: #2563eb;">0.0%</div>
                    <div id="rteStatus" style="font-size: 0.65rem; margin-top: 0.25rem; font-weight: 600;">Auditing
                        Efficiency...</div>
                </div>
                <div class="audit-card">
                    <h4>02. Ramp Rate Compliance</h4>
                    <div class="val" id="auditPumpingRisk">NORMAL</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Regulating Reserve LFC</div>
                </div>
                <div class="audit-card">
                    <h4>03. AS Revenue Cap Audit</h4>
                    <div class="val" id="auditAS">PASS</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">MAR vs Energy Opportunity</div>
                </div>
                <div class="audit-card">
                    <h4>04. Cycle Endurance</h4>
                    <div class="val" id="auditDischarge">STABLE</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Pump/Gen Mechanical Stress</div>
                </div>

                <!-- SECTION: GEOTHERMAL BASELOAD -->
                <div
                    style="grid-column: span 4; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5
                        style="font-size: 0.75rem; text-transform: uppercase; color: #8b5cf6; letter-spacing: 0.05em; font-weight: 800;">
                        ‚ô®Ô∏è Geothermal Baseload Integrity Analytics</h5>
                    <span
                        style="font-size: 0.6rem; background: #f3e8ff; color: #6b21a8; padding: 2px 8px; border-radius: 4px; font-weight: 700;">Supercritical
                        Flash Audit</span>
                </div>
                <div class="audit-card">
                    <h4>05. Thermal Efficiency (Net)</h4>
                    <div class="val" id="auditGeoEff" style="color: #8b5cf6;">0.0%</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Brayton/Rankine Recovery</div>
                </div>
                <div class="audit-card">
                    <h4>06. Reliability Factor (EAF)</h4>
                    <div class="val" id="auditGeoReliability">0%</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Target Baseload Availability</div>
                </div>
                <div class="audit-card">
                    <h4>07. Wellhead Pressure Stability</h4>
                    <div class="val" id="auditGeoWhp">OPTIMAL</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Sub-surface Reservoir Health</div>
                </div>
                <div class="audit-card">
                    <h4>08. Reinjection Ratio</h4>
                    <div class="val" id="auditGeoNcg">100%</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Environment Compliance Audit</div>
                </div>

                <!-- SECTION: IMPOUNDING HYDRO -->
                <div
                    style="grid-column: span 4; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5
                        style="font-size: 0.75rem; text-transform: uppercase; color: #0ea5e9; letter-spacing: 0.05em; font-weight: 800;">
                        üíß Impounding Hydro Optimization Protocol</h5>
                    <span
                        style="font-size: 0.6rem; background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-weight: 700;">Gened
                        Cascading Loop</span>
                </div>
                <div class="audit-card">
                    <h4>09. Hydraulic Head Efficiency</h4>
                    <div class="val" id="auditImpHead" style="color: #0ea5e9;">0.0%</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Dynamic Head vs Static Inflow</div>
                </div>
                <div class="audit-card">
                    <h4>10. Inflow Utilization Rate</h4>
                    <div class="val" id="auditImpInflow">0.0%</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Penstock Recovery Ratio</div>
                </div>
                <div class="audit-card">
                    <h4>11. Secondary Spillage Audit</h4>
                    <div class="val" id="auditImpCascade">PASS</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Downstream Catchment Stability</div>
                </div>
                <div class="audit-card">
                    <h4>12. Power Yield Coefficient</h4>
                    <div class="val" id="auditImpYield">2.41</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">MW Efficiency per m¬≥/s</div>
                </div>

                <!-- SECTION: PORTFOLIO AGGREGATES -->
                <div
                    style="grid-column: span 4; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5
                        style="font-size: 0.75rem; text-transform: uppercase; color: #1e293b; letter-spacing: 0.05em; font-weight: 800;">
                        üèõÔ∏è Cross-Discipline Portfolio Aggregates</h5>
                    <span
                        style="font-size: 0.6rem; background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-weight: 700;">Unified
                        Grid Audit</span>
                </div>
                <div class="audit-card">
                    <h4>13. Avoided Peaker (Agg)</h4>
                    <div class="val" id="auditPeaker" style="color: #059669;">‚Ç±0</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Fuel Displacement Savings</div>
                </div>
                <div class="audit-card">
                    <h4>14. Carbon Credits (CERs)</h4>
                    <div class="val" id="auditCO2">0.0 tCO2</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Portfolio Green Compliance</div>
                </div>
                <div class="audit-card">
                    <h4>15. VOLL Resilience Value</h4>
                    <div class="val" id="auditVOLL">‚Ç±0</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Energy Not Served (ENS) Buffer</div>
                </div>
                <div class="audit-card">
                    <h4>16. System Synergy Alpha</h4>
                    <div class="val" id="auditSynergy">1.00</div>
                    <div style="font-size: 0.65rem; margin-top: 0.25rem;">Diversity Volatility Hedge</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <div class="card-title">‚öñÔ∏è Expanded Regulatory Stress Test & Sensitivity Engine</div>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div class="stress-controls-panel">
                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>GEA Rate Sensitivity (PhP/kW/h)</span>
                                <span id="valGET" style="color: var(--primary);">2.5787</span>
                            </label>
                            <input type="range" min="1.5" max="8" step="0.01" value="2.5787" id="slideGET"
                                style="width: 100%; margin-top: 0.5rem;" oninput="updateStressParam('gea', this.value)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span>Competitive (1.5)</span>
                                <span>High Cost (8.0)</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>Market Volatility Factor (œÉ)</span>
                                <span id="valVol" style="color: var(--primary);">1.0</span>
                            </label>
                            <input type="range" min="0.5" max="2.5" step="0.1" value="1.0" id="slideVol"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateStressParam('volatility', this.value)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span>Stable (0.5)</span>
                                <span>Turbulent (2.5)</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>PSH Capacity Availability (%)</span>
                                <span id="valDerate" style="color: var(--success);">100%</span>
                            </label>
                            <input type="range" min="0" max="100" step="1" value="100" id="slideDerate"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateStressParam('derate', this.value)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span>Forced Outage (0%)</span>
                                <span>Full Availability (100%)</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>WESM Price Shift (Scalar)</span>
                                <span id="valScalar" style="color: var(--primary);">1.0x</span>
                            </label>
                            <input type="range" min="0.5" max="3.0" step="0.1" value="1.0" id="slideScalar"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateStressParam('scalar', this.value)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span>Low-Price (0.5x)</span>
                                <span>Price Surge (3.0x)</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>Global Project Delay (Months)</span>
                                <span id="valDelay" style="color: var(--danger);">0 m</span>
                            </label>
                            <input type="range" min="0" max="60" step="1" value="0" id="slideDelay"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateStressParam('delay', this.value)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span>On-Time</span>
                                <span>5-Year Delay</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>GEA Rate Adjustment (%)</span>
                                <span id="valRateAdj" style="color: var(--primary);">0%</span>
                            </label>
                            <input type="range" min="-20" max="50" step="1" value="0" id="slideRateAdj"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateStressParam('rateadj', this.value)">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">
                                <span>Reduced (-20%)</span>
                                <span>Escalated (+50%)</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="font-size: 0.8125rem; font-weight: 600; display: flex; justify-content: space-between;">
                                <span>Regulatory Stress Scenario</span>
                                <span class="feature-badge" id="scenarioBadge"
                                    style="background:#e0f2fe; color:#0369a1;">Baseline</span>
                            </label>
                            <select id="stressScenario" class="select-input"
                                style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; border-radius: 0.4rem; border: 1px solid var(--border-color); font-size: 0.8rem;"
                                onchange="updateStressParam('scenario', this.value)">
                                <option value="baseline">Baseline Market Conditions</option>
                                <option value="heatwave">Extreme Heat Wave (+30% Peak Demand)</option>
                                <option value="curtailment">VRE Curtailment (Higher Volatility)</option>
                                <option value="el_nino">El Ni√±o (Impounding -60% Inflow)</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="font-size: 0.7rem; font-weight: 600; color: #8b5cf6;">Geo Derate
                                    (%)</label>
                                <input type="range" min="50" max="100" step="1" value="100" style="width: 100%;"
                                    oninput="updateStressParam('geoderate', this.value)">
                            </div>
                            <div>
                                <label style="font-size: 0.7rem; font-weight: 600; color: #0ea5e9;">Hyd Reserv.
                                    (%)</label>
                                <input type="range" min="20" max="100" step="1" value="80" style="width: 100%;"
                                    oninput="updateStressParam('hydres', this.value)">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <button class="secondary-btn" id="btnMustRun" onclick="toggleMustRun()"
                                style="font-size: 0.75rem;">
                                üõ°Ô∏è Forced N-1 Dispatch
                            </button>
                            <button class="secondary-btn" id="btnZonal" onclick="toggleZonalLMP()"
                                style="font-size: 0.75rem;">
                                üìç Zonal LMP Delta
                            </button>
                        </div>
                    </div>

                    <div class="stress-analysis-panel"
                        style="background: #f8fafc; padding: 1.25rem; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <span style="font-size: 0.75rem; font-weight: 700; color: var(--text-color);">PREDICTIVE
                                RATE IMPACT ZONE</span>
                            <span id="complianceProb"
                                style="font-size: 0.7rem; font-weight: 700; color: var(--success);">100% AUDIT PASS
                                PROB</span>
                        </div>
                        <div style="height: 180px;">
                            <canvas id="sensitivityChart"></canvas>
                        </div>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div
                                style="background: #fff; padding: 0.5rem; border-radius: 0.4rem; border: 1px solid #e2e8f0; text-align: center;">
                                <div style="font-size: 0.6rem; color: var(--text-muted); font-weight: 600;">MAX RATE
                                    SPIKE</div>
                                <div id="stressMaxRI"
                                    style="font-size: 0.8rem; font-weight: 700; color: var(--danger);">‚Ç±0.0000</div>
                            </div>
                            <div
                                style="background: #fff; padding: 0.5rem; border-radius: 0.4rem; border: 1px solid #e2e8f0; text-align: center;">
                                <div style="font-size: 0.6rem; color: var(--text-muted); font-weight: 600;">CONFIDENCE
                                    LEVEL</div>
                                <div style="font-size: 0.8rem; font-weight: 700; color: var(--primary);">95% CI</div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>



            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <div class="card-title">Regulatory Metadata & Transparency</div>
                </div>
                <div style="padding: 1.25rem;">
                    <p style="font-size: 0.8125rem; color: var(--text-muted); line-height: 1.5;">
                        This auditing suite utilizes the <strong>ERC Standard Formulae</strong> for ESS/PSH settlement
                        oversight.
                    </p>
                    <button class="calc-basis-btn" onclick="showInfo('audit_methodology')">üìú View Detailed
                        Methodology</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- WESM PRICE SUPPRESSION TAB CONTENT -->
    <div id="suppression" class="tab-content" style="display: none; padding: 2rem 0; min-height: 800px;">
        <div class="card"
            style="border-top: 4px solid var(--primary); margin-bottom: 2rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
            <div class="card-header">
                <div class="card-title" style="color: var(--primary); font-weight: 800; font-size: 1.4rem;">üìä WESM
                    Price Suppression & 20-Year Forecast</div>
                <div class="feature-badge" style="background: var(--primary-light); color: var(--primary);">Economic
                    Resilience Suite</div>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 340px; gap: 2.5rem; margin-bottom: 2.5rem;">
                    <div
                        style="height: 400px; background: #fff; padding: 1rem; border: 1px solid var(--border-color); border-radius: 1rem; position: relative;">
                        <canvas id="suppression20YearChart"></canvas>
                    </div>
                    <div
                        style="background: #f8fafc; padding: 1.75rem; border-radius: 1rem; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 1.5rem;">
                        <h4
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem;">
                            Forecast Parameters</h4>

                        <div>
                            <label
                                style="font-size: 0.8125rem; font-weight: 700; display: flex; justify-content: space-between;">
                                <span>VRE Penetration</span>
                                <span id="valVRE" style="color: var(--primary);">35%</span>
                            </label>
                            <input type="range" min="20" max="80" step="5" value="35" id="slideVRE"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateSuppressionForecast('vre', this.value)">
                            <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem;">Target RE mix
                                in Luzon Grid by 2045</p>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.8125rem; font-weight: 700; display: flex; justify-content: space-between;">
                                <span>Global Fuel Trend</span>
                                <span id="valFuel" style="color: var(--primary);">1.0x</span>
                            </label>
                            <input type="range" min="0.5" max="2.5" step="0.1" value="1.0" id="slideFuel"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateSuppressionForecast('fuel', this.value)">
                            <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem;">Projected
                                relative cost of fossil fuels</p>
                        </div>
                        <div>
                            <label
                                style="font-size: 0.8125rem; font-weight: 700; display: flex; justify-content: space-between;">
                                <span>Pumped Storage (GEA3 Portfolio)</span>
                                <span id="valPshPen" style="color: #2563eb;">6350MW</span>
                            </label>
                            <input type="range" min="0" max="10000" step="50" value="6350" id="slidePsh"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateSuppressionForecast('psh', this.value)">
                            <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem;">Base: All 7
                                awarded PSH Lots (6,350 MW total)</p>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.8125rem; font-weight: 700; display: flex; justify-content: space-between;">
                                <span>Geothermal (GEA3 Portfolio)</span>
                                <span id="valGeoPen" style="color: #8b5cf6;">31MW</span>
                            </label>
                            <input type="range" min="0" max="2000" step="1" value="31" id="slideGeo"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateSuppressionForecast('geo', this.value)">
                            <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem;">Base: Tanawon,
                                Bago, Mindanao 3 (31 MW total)</p>
                        </div>

                        <div>
                            <label
                                style="font-size: 0.8125rem; font-weight: 700; display: flex; justify-content: space-between;">
                                <span>Impounding (GEA3 Portfolio)</span>
                                <span id="valHydPen" style="color: #0ea5e9;">300MW</span>
                            </label>
                            <input type="range" min="0" max="1500" step="10" value="300" id="slideHyd"
                                style="width: 100%; margin-top: 0.5rem;"
                                oninput="updateSuppressionForecast('hyd', this.value)">
                            <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem;">Base: Gened 1 &
                                Gened 2 Hydro (300 MW total)</p>
                        </div>
                        <div style="border-top: 1px solid #e2e8f0; padding-top: 1rem; margin-bottom: 1.5rem;">
                            <h4
                                style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.75rem; font-weight: 700;">
                                Fossil Fuel Displacement Heatmap</h4>
                            <div id="displacementHeatmap"
                                style="display: grid; grid-template-columns: repeat(24, 1fr); gap: 2px; height: 35px;">
                                <!-- Populated by JS -->
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.4rem;">
                                <span style="font-size: 0.55rem; font-weight: 600; color: #64748b;">12 AM (Low)</span>
                                <span style="font-size: 0.55rem; font-weight: 600; color: #f43f5e;">12 PM (Peak)</span>
                                <span style="font-size: 0.55rem; font-weight: 600; color: #64748b;">11 PM (Low)</span>
                            </div>
                        </div>
                        <div
                            style="margin-top: auto; padding: 1.25rem; border-radius: 0.75rem; background: #fff; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                            <div
                                style="font-size: 0.65rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                                20-Year Suppression Breakdown</div>

                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                                <span style="font-size: 0.75rem; color: var(--text-dark);">PSH Suppression</span>
                                <span id="savingsPSH"
                                    style="font-size: 0.75rem; font-weight: 700; color: var(--primary);">‚Ç±0.0 B</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                                <span style="font-size: 0.75rem; color: var(--text-dark);">Geothermal (Baseload)</span>
                                <span id="savingsGeo" style="font-size: 0.75rem; font-weight: 700; color: #8b5cf6;">‚Ç±0.0
                                    B</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1.25rem;">
                                <span style="font-size: 0.75rem; color: var(--text-dark);">Impounding Hydro</span>
                                <span id="savingsHyd" style="font-size: 0.75rem; font-weight: 700; color: #0ea5e9;">‚Ç±0.0
                                    B</span>
                            </div>

                            <div
                                style="background: var(--primary); padding: 0.85rem; border-radius: 0.6rem; color: white; text-align: center;">
                                <div
                                    style="font-size: 0.6rem; text-transform: uppercase; font-weight: 600; opacity: 0.9; margin-bottom: 0.15rem;">
                                    Total Portfolio Suppression</div>
                                <div id="totalSavings20yr"
                                    style="font-size: 1.35rem; font-weight: 900; letter-spacing: -0.01em;">‚Ç±0.0 Billion
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem;">
                    <div class="audit-card"
                        style="background: white; border: 1px solid var(--border-color); padding: 1.25rem;">
                        <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Peak Shaving</h4>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">Shifting peak load to cheaper base
                            generation blocks.</p>
                    </div>
                    <div class="audit-card"
                        style="background: white; border: 1px solid var(--border-color); padding: 1.25rem;">
                        <h4 style="color: var(--success); margin-bottom: 0.5rem;">RE Sponge</h4>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">Preventing curtailment during peak
                            solar solar clusters.</p>
                    </div>
                    <div class="audit-card"
                        style="background: white; border: 1px solid var(--border-color); padding: 1.25rem;">
                        <h4 style="color: var(--danger); margin-bottom: 0.5rem;">AS Liquidity</h4>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">Providing reserves to lower AS market
                            clearing prices.</p>
                    </div>
                    <div class="audit-card"
                        style="background: white; border: 1px solid var(--border-color); padding: 1.25rem;">
                        <h4 style="color: var(--warning); margin-bottom: 0.5rem;">Merit Shift</h4>
                        <p style="font-size: 0.75rem; color: var(--text-muted);">Flattening the supply curve to lower
                            the marginal price.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- STRATEGIC ROADMAP -->
        <div class="card" style="border-top: 4px solid var(--success); margin-bottom: 2rem;">
            <div class="card-header">
                <div class="card-title" style="color: var(--success); font-weight: 800;">üöÄ PSH Strategic Market Roadmap
                    (2025 - 2045)</div>
            </div>
            <div style="padding: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem;">
                    <div style="border-left: 2px solid var(--border-color); padding-left: 1.5rem; position: relative;">
                        <div
                            style="position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--border-color);">
                        </div>
                        <h5 style="color: var(--text-dark); margin-bottom: 0.75rem;">Phase 1: Stabilization (2025-2030)
                        </h5>
                        <ul
                            style="font-size: 0.725rem; color: var(--text-muted); list-style: none; display: flex; flex-direction: column; gap: 0.5rem;">
                            <li>‚Ä¢ Initial 2.5GW Integration</li>
                            <li>‚Ä¢ Frequency Response focus</li>
                            <li>‚Ä¢ PSH specific AS Settlement</li>
                        </ul>
                    </div>
                    <div style="border-left: 2px solid var(--primary); padding-left: 1.5rem; position: relative;">
                        <div
                            style="position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--primary);">
                        </div>
                        <h5 style="color: var(--primary); margin-bottom: 0.75rem;">Phase 2: Optimization (2031-2038)
                        </h5>
                        <ul
                            style="font-size: 0.725rem; color: var(--text-muted); list-style: none; display: flex; flex-direction: column; gap: 0.5rem;">
                            <li>‚Ä¢ Bulk Arbitrage Dominance</li>
                            <li>‚Ä¢ Solar Peak Management</li>
                            <li>‚Ä¢ Grid-Scale Congestion Relief</li>
                        </ul>
                    </div>
                    <div style="border-left: 2px solid var(--success); padding-left: 1.5rem; position: relative;">
                        <div
                            style="position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--success);">
                        </div>
                        <h5 style="color: var(--success); margin-bottom: 0.75rem;">Phase 3: Maturity (2039-2045)</h5>
                        <ul
                            style="font-size: 0.725rem; color: var(--text-muted); list-style: none; display: flex; flex-direction: column; gap: 0.5rem;">
                            <li>‚Ä¢ Merit Curve Neutralization</li>
                            <li>‚Ä¢ Decentralized ESS Hubs</li>
                            <li>‚Ä¢ Long-term Price Stability</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONVENTIONAL PLANT DISPLACEMENT ANALYTICS -->
        <div class="card" style="border-top: 4px solid var(--danger); margin-bottom: 2rem;">
            <div class="card-header">
                <div class="card-title" style="color: var(--danger); font-weight: 800;">üìâ Conventional Plant
                    Displacement Matrix</div>
                <div class="feature-badge" style="background: #fef2f2; color: #991b1b;">High-Cost Asset Replacement
                </div>
            </div>
            <div style="padding: 1.5rem;">
                <p
                    style="font-size: 0.8125rem; color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.5; border-left: 3px solid var(--danger); padding-left: 0.75rem;">
                    Pumped storage facilitates the transition away from high-carbon, high-marginal-cost fuel sources. By
                    charging with solar surplus and discharging
                    during demand peaks, PSH targets the displacement of the following conventional units in the WESM
                    merit order.
                </p>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <thead>
                            <tr
                                style="border-bottom: 1px solid var(--border-color); text-align: left; color: var(--text-muted);">
                                <th style="padding: 0.75rem;">Generating Asset</th>
                                <th style="padding: 0.75rem;">Technology</th>
                                <th style="padding: 0.75rem;">Current Grid Role</th>
                                <th style="padding: 0.75rem; text-align: center;">Cap (MW)<sup
                                        style="color:var(--primary)">[1]</sup></th>
                                <th style="padding: 0.75rem; text-align: center;">Price (‚Ç±/kWh)<sup
                                        style="color:var(--primary)">[2]</sup></th>
                                <th style="padding: 0.75rem; text-align: right;">Probability of Displacement</th>
                            </tr>
                        </thead>
                        <tbody id="displacedPlantsBody">
                            <!-- Populated by updateDisplacementTable() -->
                        </tbody>
                    </table>
                </div>
                <div
                    style="margin-top: 1rem; padding: 1.25rem; border-radius: 0.75rem; background: var(--success-light); border: 1px solid var(--success); text-align: center;">
                    <div
                        style="font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--success); opacity:0.9;">
                        üåç Lifetime Carbon Emissions Displaced</div>
                    <div id="co2Tracker"
                        style="font-size: 1.5rem; font-weight: 800; color: #166534; margin-top: 0.25rem;">0.00 M Metric
                        Tons (tCO2e)</div>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed var(--border-color);">
                    <p style="font-size: 0.65rem; color: var(--text-muted); line-height: 1.4;">
                        <span style="color: var(--primary); font-weight: 700;">[1] Source:</span> DOE List of Existing
                        Generating Facilities (Luzon/Visayas/Mindanao) - 2024 Update.<br>
                        <span style="color: var(--primary); font-weight: 700;">[2] Source:</span> IEMOP Market
                        Surveillance Unit (MSU) Fuel Proxy Annex & ERC Benchmark Costs for Oil-Based/Aging Coal Units
                        (2023-2024).<br>
                        <span style="font-style: italic;">*Displacement probability calculated via PSH Merit Order
                            Neutralization modeling as per DOE DC2024-01-0003 Section 4.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    <!-- GEA3 GEOTHERMAL TAB CONTENT -->
    <div id="geothermal" class="tab-content" style="display: none; padding: 2rem 0;">
        <div class="card" style="border-top: 4px solid #8b5cf6; margin-bottom: 2rem;">
            <div class="card-header">
                <div class="card-title" style="color: #8b5cf6; font-weight: 800;">‚ô®Ô∏è GEA3 Geothermal Winning Bidders
                    (2025-2027)</div>
                <div class="feature-badge" style="background: #f5f3ff; color: #5b21b6;">Baseload Indigenous</div>
            </div>
            <div style="padding: 1.5rem;">
                <p
                    style="font-size: 0.8125rem; color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.5; border-left: 3px solid #8b5cf6; padding-left: 0.75rem;">
                    Geothermal projects in GEA3 provide supercritical baseload stability. Unlike PSH, these units offer
                    a constant
                    Pmax profile with zero fuel volatility risk, securing the grid's foundation.
                </p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;" id="geoGrid">
                    <!-- Populated by script -->
                </div>
                <div
                    style="margin-top: 2rem; background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border-color);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h4 style="color: #5b21b6;">Supercritical 15-Minute Dispatch Sim</h4>
                            <p style="font-size: 0.75rem; color: var(--text-muted);">Real-time baseload thermal profile
                                vs. WESM volatility</p>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="primary-btn" id="playBtnGeo" onclick="toggleGeoSim()"
                                style="background: #8b5cf6;">Start Baseload Cycle</button>
                            <button class="secondary-btn" onclick="resetGeoSim()"
                                style="color: #5b21b6; background: #f3e8ff;">Reset Geo</button>
                        </div>
                    </div>

                    <!-- GEO TAB DERATING CONTROL -->
                    <div
                        style="background: rgba(139, 92, 246, 0.05); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px dashed #8b5cf6;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label style="font-size: 0.75rem; font-weight: 700; color: #5b21b6;">‚ô®Ô∏è Thermal Derating
                                Limit (%)</label>
                            <span id="valGeoDerateTab"
                                style="font-size: 0.9rem; font-weight: 800; color: #8b5cf6;">100%</span>
                        </div>
                        <input type="range" min="50" max="100" step="1" value="100" id="slideGeoDerateTab"
                            style="width: 100%; margin-top: 0.5rem;"
                            oninput="updateStressParam('geoderate', this.value)">
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">Current
                                Temp</div>
                            <div id="geoTemp" style="font-size: 1.2rem; font-weight: 700; color: #8b5cf6;">320¬∞C</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">
                                Efficiency (Œ∑)</div>
                            <div id="geoEff" style="font-size: 1.2rem; font-weight: 700; color: #10b981;">98.4%</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">Market
                                Revenue</div>
                            <div id="geoRev" style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">‚Ç±0
                            </div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">Grid
                                Status</div>
                            <div id="geoStatus" style="font-size: 0.9rem; font-weight: 700; color: #64748b;">STANDBY
                            </div>
                        </div>
                    </div>
                    <!-- WELLS TELEMETRY -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">
                                Wellhead Pressure</div>
                            <div id="geoWhp" style="font-size: 1.1rem; font-weight: 700; color: #6366f1;">0 psi</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">Brine
                                Reinjection</div>
                            <div id="geoBrine" style="font-size: 1.1rem; font-weight: 700; color: #0ea5e9;">0 m¬≥/h</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">NCG
                                Content</div>
                            <div id="geoNcg" style="font-size: 1.1rem; font-weight: 700; color: #64748b;">0.0%</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">Steam
                                Enthalpy</div>
                            <div id="geoEnt" style="font-size: 1.1rem; font-weight: 700; color: #f43f5e;">0 kJ/kg</div>
                        </div>
                    </div>
                    <!-- GEO ADVANCED TELEMETRY -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div
                            style="background: rgba(139, 92, 246, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed var(--primary);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">Makeup
                                Wells Needed</div>
                            <div id="geoMakeupWells" style="font-size: 1rem; font-weight: 800; color: #8b5cf6;">0 Units
                            </div>
                        </div>
                        <div
                            style="background: rgba(139, 92, 246, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed var(--primary);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Ambient Temp Derate</div>
                            <div id="geoAmbDerate" style="font-size: 1rem; font-weight: 800; color: #f43f5e;">0.0%</div>
                        </div>
                        <div
                            style="background: rgba(139, 92, 246, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed var(--primary);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">Flash
                                Efficiency</div>
                            <div id="geoFlashEff" style="font-size: 1rem; font-weight: 800; color: #10b981;">0.0%</div>
                        </div>
                        <div
                            style="background: rgba(139, 92, 246, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed var(--primary);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">NCG
                                Parasitic Load</div>
                            <div id="geoNcgLoad" style="font-size: 1rem; font-weight: 800; color: #64748b;">0.00 MW
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-Time Revenue Telemetry Card -->
                <div
                    style="background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); margin-bottom: 1.5rem; margin-top: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; font-weight: 800; color: #5b21b6;">üìâ REAL-TIME SETTLEMENT
                            TELEMETRY (DAILY CYCLE)</div>
                        <div id="geoSimTime" style="font-size: 0.7rem; font-weight: 800; color: #8b5cf6;">00:00 H
                        </div>
                    </div>
                    <div style="height: 350px;">
                        <canvas id="geoRevenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Economic Merit Profile</div>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="height: 300px;"><canvas id="geoChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">20-Year Grid Impact Roadmap</div>
                </div>
                <div style="padding: 1rem;">
                    <canvas id="roadmapChartGeo" style="height: 200px; width: 100%; margin-bottom: 1.5rem;"></canvas>
                </div>
                <div style="overflow-x: auto;">
                    <table class="settlement-table" style="font-size: 0.75rem;">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th style="color:#2563eb">PSH (‚Ç±)</th>
                                <th style="color:#8b5cf6">GEO (‚Ç±)</th>
                                <th style="color:#0ea5e9">HYD (‚Ç±)</th>
                                <th style="text-align: right;">Total (‚Ç±)</th>
                            </tr>
                        </thead>
                        <tbody id="roadmapTableBodyGeo"></tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-color);">
                    <p style="font-size: 0.65rem; color: var(--text-muted); line-height: 1.4;">
                        <span style="color: #8b5cf6; font-weight: 700;">Data Source:</span> GEA3 Notice of Award (DOE
                        2025). Thermal efficiency curves based on Supercritical Flash Plant (Double-Flash) engineering
                        benchmarks.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- GEA3 IMPOUNDING HYDRO TAB CONTENT -->
    <div id="impounding" class="tab-content" style="display: none; padding: 2rem 0;">
        <div class="card" style="border-top: 4px solid #0ea5e9; margin-bottom: 2rem;">
            <div class="card-header">
                <div class="card-title" style="color: #0ea5e9; font-weight: 800;">üåä GEA3 Impounding Hydro Winning
                    Bidders (2028-2030)</div>
                <div class="feature-badge" style="background: #f0f9ff; color: #075985;">Flexible Storage</div>
            </div>
            <div style="padding: 1.5rem;">
                <p
                    style="font-size: 0.8125rem; color: var(--text-dark); margin-bottom: 1.5rem; line-height: 1.5; border-left: 3px solid #0ea5e9; padding-left: 0.75rem;">
                    Large-scale impounding hydro projects (Gened 1 & 2) act as massive seasonal buffers for the Luzon
                    grid,
                    providing significant Ancillary Services and displacement of mid-merit coal during wet seasons.
                </p>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;" id="impoundGrid">
                    <!-- Populated by script -->
                </div>
                <div
                    style="margin-top: 2rem; background: #f0f9ff; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border-color);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h4 style="color: #075985;">Flexible 15-Minute Hydrological Sim</h4>
                            <p style="font-size: 0.75rem; color: var(--text-muted);">Seasonal inflow management and
                                mid-merit displacement</p>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="primary-btn" id="playBtnImp" onclick="toggleImpSim()"
                                style="background: #0ea5e9;">Start Hydro Cycle</button>
                            <button class="secondary-btn" onclick="resetImpSim()"
                                style="color: #075985; background: #e0f2fe;">Reset Hydro</button>
                        </div>
                    </div>

                    <!-- IMP TAB DERATING CONTROL -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div
                            style="background: rgba(14, 165, 233, 0.05); padding: 1.25rem; border-radius: 1rem; border: 1px dashed #0ea5e9;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <label style="font-size: 0.85rem; font-weight: 800; color: #075985;">üåä Reservoir
                                    Headwater Level (%)</label>
                                <span id="valHydResTab"
                                    style="font-size: 1.1rem; font-weight: 900; color: #0ea5e9;">80%</span>
                            </div>
                            <input type="range" min="20" max="100" step="1" value="80" id="slideHydResTab"
                                style="width: 100%;" oninput="updateStressParam('hydres', this.value)">
                            <p style="font-size: 0.7rem; color: #64748b; margin-top: 0.75rem;">Adjust head percentage to
                                simulate seasonal drawdown and energy storage capability.</p>
                        </div>

                        <div
                            style="background: white; padding: 1rem; border-radius: 1rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                            <div
                                style="font-size: 0.75rem; font-weight: 700; color: #075985; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                üåßÔ∏è Monthly Rainwater Projection (Gened Location)
                            </div>
                            <div style="height: 120px;">
                                <canvas id="rainChartGened"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Real-Time Revenue Telemetry Card -->
                    <div
                        style="background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); margin-bottom: 1.5rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 800; color: #075985;">üìâ REAL-TIME SETTLEMENT
                                TELEMETRY (DAILY CYCLE)</div>
                            <div id="impSimTime" style="font-size: 0.7rem; font-weight: 800; color: #0ea5e9;">00:00 H
                            </div>
                        </div>
                        <div style="height: 200px;">
                            <canvas id="impRevenueChart"></canvas>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem;">
                        <div
                            style="background: #fff; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Reservoir Head</div>
                            <div id="impHead" style="font-size: 1.1rem; font-weight: 700; color: #0ea5e9;">120m</div>
                        </div>
                        <div
                            style="background: #fff; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Spillage Loss</div>
                            <div id="impSpill" style="font-size: 1.1rem; font-weight: 700; color: var(--danger);">0 m¬≥/s
                            </div>
                        </div>
                        <div
                            style="background: #fff; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">Inflow
                                Source</div>
                            <div id="impInflow" style="font-size: 1.1rem; font-weight: 700; color: #065f46;">85 m¬≥/s
                            </div>
                        </div>
                        <div
                            style="background: #fff; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Accrued Revenue</div>
                            <div id="impRev" style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">‚Ç±0
                            </div>
                        </div>
                        <div
                            style="background: #fff; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Dispatch Mode</div>
                            <div id="impMode" style="font-size: 0.8rem; font-weight: 700; color: #64748b;">STANDBY</div>
                        </div>
                    </div>
                    <!-- HYDRO DYNAMICS TELEMETRY -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">Gate
                                Opening</div>
                            <div id="impGate" style="font-size: 1.1rem; font-weight: 700; color: #f59e0b;">0.0%</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">
                                Tailwater Level</div>
                            <div id="impTail" style="font-size: 1.1rem; font-weight: 700; color: #0ea5e9;">10.2m</div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">
                                Specific Yield</div>
                            <div id="impYield" style="font-size: 1.1rem; font-weight: 700; color: #059669;">2.4 kWh/m¬≥
                            </div>
                        </div>
                        <div
                            style="background: #fff; padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted);">
                                Penstock Velocity</div>
                            <div id="impVel" style="font-size: 1.1rem; font-weight: 700; color: #2563eb;">0.0 m/s</div>
                        </div>
                    </div>
                    <!-- HYDRO ADVANCED TELEMETRY -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div
                            style="background: rgba(14, 165, 233, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed #0ea5e9;">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Cascading Inflow Lag</div>
                            <div id="impCascadingLag" style="font-size: 1rem; font-weight: 800; color: #0ea5e9;">15 min
                            </div>
                        </div>
                        <div
                            style="background: rgba(14, 165, 233, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed #0ea5e9;">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Reservoir Siltation</div>
                            <div id="impSiltation" style="font-size: 1rem; font-weight: 800; color: #92400e;">0.0%</div>
                        </div>
                        <div
                            style="background: rgba(14, 165, 233, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed #0ea5e9;">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Hydraulic Recovery</div>
                            <div id="impHydRecov" style="font-size: 1rem; font-weight: 800; color: #10b981;">0.0%</div>
                        </div>
                        <div
                            style="background: rgba(14, 165, 233, 0.05); padding: 0.75rem; border-radius: 0.5rem; border: 1px dashed #0ea5e9;">
                            <div style="font-size: 0.55rem; text-transform: uppercase; color: var(--text-muted);">
                                Spillway Loss</div>
                            <div id="impSpillLoss" style="font-size: 1.1rem; font-weight: 800; color: #f43f5e;">0.00 MWh
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Seasonal Hydrological Optimization</div>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="height: 300px;"><canvas id="impoundChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">20-Year Grid Impact Roadmap</div>
                </div>
                <div style="padding: 1rem;">
                    <canvas id="roadmapChartImp" style="height: 200px; width: 100%; margin-bottom: 1.5rem;"></canvas>
                </div>
                <div style="overflow-x: auto;">
                    <table class="settlement-table" style="font-size: 0.75rem;">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th style="color:#2563eb">PSH (‚Ç±)</th>
                                <th style="color:#8b5cf6">GEO (‚Ç±)</th>
                                <th style="color:#0ea5e9">HYD (‚Ç±)</th>
                                <th style="text-align: right;">Total (‚Ç±)</th>
                            </tr>
                        </thead>
                        <tbody id="roadmapTableBodyImp"></tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-color);">
                    <p style="font-size: 0.65rem; color: var(--text-muted); line-height: 1.4;">
                        <span style="color: #0ea5e9; font-weight: 700;">Data Source:</span> Gened 1 & 2 Technical
                        Specifications (Pan Pacific Hydro / DOE GEA3 Lot 6-8). Seasonal inflow models based on PAGASA
                        Hydrological Forecast Units.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- MASTER REGULATORY REFERENCES SECTION -->
        <div class="card"
            style="border-top: 4px solid #64748b; margin-top: 2rem; background: #f8fafc; margin-bottom: 2rem;">
            <div class="card-header">
                <div class="card-title" style="color: #334155; font-weight: 800;">üìö Regulatory Data Integrity &
                    Citations</div>
            </div>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h4 style="font-size: 0.75rem; text-transform: uppercase; color: #475569; margin-bottom: 1rem;">
                        Policy & Legal Framework</h4>
                    <ul style="font-size: 0.75rem; color: #64748b; list-style: none; padding: 0;">
                        <li style="margin-bottom:0.75rem;">‚Ä¢ <strong style="color:#334155;">DOE DC2024-01-0003:</strong>
                            Supplemental Policy on Pumped Storage and Kalayaan Pumped Storage Power Plant (KPSPP).</li>
                        <li style="margin-bottom:0.75rem;">‚Ä¢ <strong style="color:#334155;">DOE DC2023-01-0001:</strong>
                            Implementing Guidelines for the GEA3 Green Energy Auction for Non-FIT Assets.</li>
                        <li style="margin-bottom:0.75rem;">‚Ä¢ <strong style="color:#334155;">ERC Case 2023-011
                                RC:</strong> Guidelines for the Recovery of Ancillary Services Costs by the System
                            Operator.</li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-size: 0.75rem; text-transform: uppercase; color: #475569; margin-bottom: 1rem;">
                        Market Data & Engineering Benchmarks</h4>
                    <ul style="font-size: 0.75rem; color: #64748b; list-style: none; padding: 0;">
                        <li style="margin-bottom:0.75rem;">‚Ä¢ <strong style="color:#334155;">WESM Prices:</strong>
                            IEMOP Historical Market Reports & SMR Statistics (2022-2025).</li>
                        <li style="margin-bottom:0.75rem;">‚Ä¢ <strong style="color:#334155;">Carbon Emission
                                Factor:</strong> 0.7 tCO2/MWh per DENR-EMB Philippines National Grid Emission Factor
                            (PGEF).</li>
                        <li style="margin-bottom:0.75rem;">‚Ä¢ <strong style="color:#334155;">VOLL (Value of Lost
                                Load):</strong> ‚Ç±20,000/MWh benchmark as per ERC Reliability Standards and National Grid
                            Code.</li>
                    </ul>
                </div>
            </div>
            <div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; font-size: 0.65rem; color: #94a3b8;">
                Disclaimer: This simulator is a regulatory analysis tool designed for portfolio impact assessment and
                does not replace actual billing settlements under the WESM Rules. All PSH/GEO/IMP values are based on
                final GEA3 winning bid disclosures.
            </div>
        </div>
    </div>

    <div class="footer-credit">
        Developed by Franz Xyrlo I. Tobias, PEE
    </div>

    <script>
        // GEA3 Plant Data from Official Notice of Award
        const PLANTS = {
            // PSH Units
            kibungan: { developer: "Coheco Badeo", name: "Kibungan PSH", capacity: 500, units: 2, unitCap: 250, rate: 2.5787, group: "2028-2030", lot: "Lot 1", startYear: 2028, type: 'PSH' },
            wawa1: { developer: "Olympia Violago", name: "Wawa PSH 1", capacity: 600, units: 3, unitCap: 200, rate: 5.3561, group: "2028-2030", lot: "Lot 1", startYear: 2029, type: 'PSH' },
            pakil: { developer: "Ahunan Power", name: "Pakil PSH", capacity: 1400, units: 4, unitCap: 350, rate: 5.4597, group: "2028-2030", lot: "Lot 1", startYear: 2030, type: 'PSH' },
            sr_lower: { developer: "San Roque Hydro", name: "SR Lower East", capacity: 800, units: 2, unitCap: 400, rate: 3.2500, group: "2031-2035", lot: "Lot 2", startYear: 2031, type: 'PSH' },
            sr_west: { developer: "San Roque Hydro", name: "SR West", capacity: 800, units: 2, unitCap: 400, rate: 3.3350, group: "2031-2035", lot: "Lot 2", startYear: 2032, type: 'PSH' },
            maton: { developer: "Pan Pacific", name: "Maton PSH", capacity: 2000, units: 4, unitCap: 500, rate: 3.5000, group: "2031-2035", lot: "Lot 3", startYear: 2033, type: 'PSH' },
            aklan: { developer: "San Roque Hydro", name: "Aklan PSH", capacity: 250, units: 2, unitCap: 125, rate: 3.7319, group: "2031-2035", lot: "Lot 3", startYear: 2034, type: 'PSH' },

            // Geothermal Units (Extracted from NOA)
            mindanao3: { developer: "EDC", name: "Mindanao 3 Binary", capacity: 3.669, units: 1, unitCap: 3.669, rate: 5.0512, group: "2025-2027", lot: "GEO-1", startYear: 2025, type: 'GEO' },
            tanawon: { developer: "Bac-Man Geothermal", name: "Tanawon Unit 1", capacity: 21.573, units: 1, unitCap: 21.573, rate: 4.8821, group: "2025-2027", lot: "GEO-1", startYear: 2026, type: 'GEO' },
            bago: { developer: "EDC", name: "Bago Binary Unit 1", capacity: 5.645, units: 1, unitCap: 5.645, rate: 5.2210, group: "2025-2027", lot: "GEO-1", startYear: 2027, type: 'GEO' },

            // Impounding Units (Extracted from NOA)
            gened1: { developer: "Pan Pacific", name: "Gened 1 Hydro", capacity: 150.0, units: 1, unitCap: 150.0, rate: 4.2500, group: "2028-2030", lot: "HYD-1", startYear: 2028, type: 'IMP' },
            gened2: { developer: "Pan Pacific", name: "Gened 2 Hydro", capacity: 150.0, units: 1, unitCap: 150.0, rate: 4.3500, group: "2028-2030", lot: "HYD-2", startYear: 2029, type: 'IMP' }
        };

        const HISTORICAL_PRICES = {
            2025: 3.81,
            2024: 4.99,
            2023: 5.96,
            2022: 7.42
        };

        const SEASONS = {
            default: { name: "Average", volatility: 1.1, peakMulti: 1.7 }
        };
        let currentSeason = 'default';

        // Assumed system-wide monthly demand for rate impact calculation
        const SYSTEM_DEMAND_MONTHLY_MWH = 8000000;

        let currentPlant = "kibungan";
        let capacityMW = 500;
        const ROUNDTRIP_EFF = 0.75;
        let nonFitGet = 2.5787;
        const INTERVALS = 288;

        let currentInterval = 0;
        let isSimulating = false;
        let simInterval;
        let pshHistory = [];
        let gened1DischargeHistory = Array(4).fill(40); // For cascading logic

        let currentYear = 2025;
        // currentSeason is already declared above with 'default' 

        let marketData = [];
        let waterLevel = 50;
        let cumulativeGEA = 0;
        let cumulativeEnergy = 0;
        let cumulativePumping = 0;
        let cumulativeAS = 0;
        let totalMWhGen = 0;
        let totalMWhPump = 0;

        let mustRunActive = false;
        let zonalLMPActive = false;
        let pshDerateFactor = 1.0;
        let marketPriceScalar = 1.0;
        let globalProjectDelay = 0; // Months
        let geaRateAdjustment = 1.0; // Multiplier

        // GEA3 Expansion Variables
        let pshPenetration = 6350;
        let geoPenetration = 31;
        let hydPenetration = 300;
        let geoDerateLimit = 1.0;
        let hydReservoirLevel = 0.8;

        let geoSimInterval;
        let isGeoSimulating = false;
        let geoCumulativeRev = 0;
        let geoCurrentInterval = 0;
        let geoRevenueChart = null;

        let impSimInterval;
        let isImpSimulating = false;
        let impCumulativeRev = 0;
        let impCurrentInterval = 0;
        let impRevenueChart = null;

        let geoCumulativeMWh = 0;
        let impCumulativeMWh = 0;
        let impCumulativeInflow = 0;
        let impCumulativeSpill = 0;


        // Initialize Chart
        const ctx = document.getElementById('pshChart').getContext('2d');
        const pshChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: INTERVALS }, (_, i) => {
                    let h = Math.floor(i / 12);
                    let m = (i % 12) * 5;
                    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                }),
                datasets: [
                    {
                        label: 'WESM Price (PHP/kWh)',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        yAxisID: 'y',
                        tension: 0.3, pointRadius: 0, fill: true
                    },
                    {
                        label: 'PSH Dispatch (MW)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        yAxisID: 'y1',
                        type: 'bar', barThickness: 2
                    },
                    {
                        label: 'GEAP Bid (LCOE)',
                        data: [],
                        borderColor: '#f59e0b',
                        borderDash: [5, 5],
                        backgroundColor: 'transparent',
                        yAxisID: 'y',
                        tension: 0, pointRadius: 0, fill: false
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { ticks: { maxTicksLimit: 12 } },
                    y: { title: { display: true, text: 'Price (PHP/kWh)' }, position: 'left' },
                    y1: { title: { display: true, text: 'Dispatch (MW)' }, position: 'right', min: -2000, max: 2000 }
                }
            }
        });

        const infoContent = {
            wesm_price: {
                title: "WESM GWAP (2022-2025)",
                citation: "IEMOP GWAP Database",
                body: "Historical Generation Weighted Average Prices (GWAP): 2025 (‚Ç±3.81), 2024 (‚Ç±4.99), 2023 (‚Ç±5.96), 2022 (‚Ç±7.42). PSH leverages these price signals by absorbing excess energy during low-price periods and dispatching during costly peak hours."
            },
            rate_impact: {
                title: "Potential Rate Impact",
                citation: "Supplemental PSH Policy Section 8.2",
                body: "Rate Impact reflects the net cost or benefit passed to consumers (PhP/kWh). <br><br><strong>Logic:</strong> [Total GEA - (Energy Revenue - Pumping Cost) - AS Revenue] / Total System Demand (kWh). <br><br><em>Note: If the net settlement is negative (Revenue > Costs), the impact is 0.0000 or a flow-back.</em>"
            },
            audit_methodology: {
                title: "ERC Advanced Regulatory Compliance Metrics",
                body: `The following formulas define the renumbered regulatory metrics for the PSH suite: <br><br>
                    <b>01. RTE Compliance:</b> Physical <em>Œ∑ = Œ£E<sub>out</sub> / Œ£E<sub>in</sub></em>. Ref: DOE Supplemental Policy Sec 6.1. Target ‚â• 75%.<br>
                    <b>02. Avoided Peaker Cost:</b> <em>V<sub>avoid</sub> = Œ£E<sub>inj</sub> * (P<sub>oil</sub> - P<sub>mkt</sub>)</em>. Oil proxy ‚Ç±15/kWh constant.<br>
                    <b>03. VOLL Resilience:</b> Value = <em>S<sub>mwh</sub> * VOLL</em>. (PHT 20,000/MWh). Ref: ERC ASPP Guidelines.<br>
                    <b>04. Carbon Credits:</b> <em>C = Œ£E<sub>inj</sub> * 0.7 tCO2/MWh</em>. Ref: DENR Grid Emission Factor 2023.<br>
                    <b>05. Pumping Risk Factor:</b> Volatility risk = <em>Price<sub>avg_pump</sub> / Price<sub>avg_annual</sub></em>. Target < 1.0.<br>
                    <b>06. AS Revenue Cap:</b> Revenue audit based on DOE 'Maximum Allowable Revenue' (MAR) for secondary reserves.<br>
                    <b>07. Multi-Project Synergy:</b> Benefit = <em>1 - (Var<sub>combined</sub> / Œ£Var<sub>individual</sub>)</em>. Portfolio volatility reduction.`,
                citation: "DOE DC2024-01-0003 & ERC Case 2023-011 RC"
            }
        };

        function showInfo(key) {
            const info = infoContent[key] || { title: key, citation: "Internal", body: "Explanation not available." };
            document.getElementById('modalCitation').innerText = info.citation;
            document.getElementById('modalTitle').innerText = info.title;
            document.getElementById('modalBody').innerHTML = info.body;
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function populateTable() {
            const body = document.getElementById('plantTableBody');
            body.innerHTML = '';

            // Assume 6 hours of high price injection and 6 hours of pumping for comparison
            const avgPrice = HISTORICAL_PRICES[currentYear];
            const pumpPrice = avgPrice * 0.8;
            const injPrice = avgPrice * 1.3;
            const hoursPerMonth = 30 * 24;

            Object.values(PLANTS).forEach(p => {
                // Approximate monthly settlement math for comparison
                const monthlyGEA = p.capacity * 1000 * p.rate * hoursPerMonth;
                const monthlyEnergy = p.capacity * 1000 * injPrice * (30 * 6); // 6 hrs injection/day
                const monthlyPumping = p.capacity * 1000 * pumpPrice * (30 * 6); // 6 hrs pumping/day
                const monthlyAS = p.capacity * 3.5 * hoursPerMonth;

                const netSettlement = monthlyGEA - (monthlyEnergy - monthlyPumping) - monthlyAS;
                const ri = Math.max(0, netSettlement) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);

                body.innerHTML += `<tr>
                    <td><span class="feature-badge" style="background:#f1f5f9; color:#475569;">${p.lot}</span></td>
                    <td>${p.name}</td>
                    <td>${p.capacity} MW<br><small style="color: var(--text-muted)">${p.units}x${p.unitCap}MW</small></td>
                    <td>‚Ç±${p.rate.toFixed(4)}</td>
                    <td style="text-align: right; font-weight: 600; color: var(--primary);">‚Ç±${ri.toFixed(4)}</td>
                </tr>`;
            });
        }

        function updatePlant() {
            const key = document.getElementById('plantSelect').value;
            const p = PLANTS[key];
            currentPlant = key;
            capacityMW = p.capacity;
            nonFitGet = p.rate;

            // Updated selection display
            document.getElementById('selDeveloper').innerText = p.developer;
            document.getElementById('selFacility').innerText = p.name;
            document.getElementById('selLot').innerText = p.lot;
            document.getElementById('selPrice').innerText = `‚Ç±${p.rate.toFixed(4)}/kW/h`;
            document.getElementById('selConfig').innerText = `${p.units} Units x ${p.unitCap} MW`;

            pshChart.options.scales.y1.min = -capacityMW;
            pshChart.options.scales.y1.max = capacityMW;
            resetSim();
        }

        function generateMarketData() {
            const base = HISTORICAL_PRICES[currentYear] * marketPriceScalar;
            const s = SEASONS[currentSeason];
            marketData = [];
            for (let i = 0; i < INTERVALS; i++) {
                const hour = i / 12;
                let multiplier = 1.0;
                if (hour >= 10 && hour <= 15) multiplier = 1.3 * s.volatility;
                if (hour >= 18 && hour <= 21) multiplier = s.peakMulti;
                if (hour >= 0 && hour <= 5) multiplier = 0.6;
                let price = base * multiplier + (Math.random() - 0.5) * (10 * s.volatility);
                marketData.push(Math.max(0.5, price));
            }
        }



        function setYear(year) {
            currentYear = year;
            document.querySelectorAll('.year-pill').forEach(p => {
                p.classList.remove('active');
                if (p.innerText.includes(year)) p.classList.add('active');
            });
            populateTable();
            resetSim();
        }

        function resetSim() {
            currentInterval = 0;
            waterLevel = 50;
            cumulativeGEA = 0; cumulativeEnergy = 0; cumulativePumping = 0; cumulativeAS = 0;
            totalMWhGen = 0; totalMWhPump = 0;
            generateMarketData();
            updateUI(null, 0);
            pshChart.data.datasets[0].data = [];
            pshChart.data.datasets[1].data = [];
            pshChart.data.datasets[2].data = [];
            pshChart.update();

            document.getElementById('policyLog').innerHTML = '<div style="color: #94a3b8;">[SYSTEM] Simulation Reset. Awaiting Cycle...</div>';

            document.getElementById('verdictTitle').innerText = "Simulation Reset";
            document.getElementById('verdictBody').innerText = "Click Run to analyze " + PLANTS[currentPlant].name + " for " + currentYear + ".";
            document.getElementById('consumerVerdictCard').style.background = "var(--primary-light)";
            document.getElementById('consumerVerdictCard').style.borderColor = "var(--primary)";
        }

        function addLog(msg, color = "#38bdf8") {
            const log = document.getElementById('policyLog');
            const timeStr = (currentInterval > 0) ? pshChart.data.labels[currentInterval - 1] : "0.0";
            log.innerHTML += `<div><span style="color: #64748b;">[${timeStr}h]</span> <span style="color:${color}">${msg}</span></div>`;
            log.scrollTop = log.scrollHeight;
        }

        function step() {
            if (currentInterval >= INTERVALS) {
                toggleSim();
                finalizeVerdict();
                addLog("CRITICAL: 24h Cycle Complete. Finalizing Regulatory Verdict.", "#10b981");
                return;
            }

            const price = marketData[currentInterval];
            let dispatch = 0;
            let logMsg = "";

            const avg = HISTORICAL_PRICES[currentYear];

            if (mustRunActive) {
                dispatch = capacityMW * pshDerateFactor;
                waterLevel -= 0.5 * pshDerateFactor;
                logMsg = `[DC Sec 6.3] GRID ALERT: Forced N-1 Dispatch. Prioritizing Stability over Market.`;
            } else if (price > (avg * 1.3) && waterLevel > 10) {
                dispatch = capacityMW * pshDerateFactor;
                waterLevel -= 0.5 * pshDerateFactor;
                logMsg = `[DC Sec 4.2] Generation Triggered: Price (‚Ç±${price.toFixed(2)}) > 1.3x Benchmark.`;
            } else if (price < (avg * 0.8) && waterLevel < 95) {
                dispatch = -capacityMW * pshDerateFactor;
                waterLevel += 0.5 * ROUNDTRIP_EFF * pshDerateFactor;
                logMsg = `[DC Sec 4.2] Pumping Triggered: Charging at Low-Cost WESM (‚Ç±${price.toFixed(2)}).`;
            } else {
                logMsg = `[DC Sec 3.1] Standby: Accruing GEA Capacity Availability Payment.`;
            }

            addLog(logMsg);

            const duration = 5 / 60;
            cumulativeGEA += (capacityMW * 1000 * nonFitGet * duration);

            if (dispatch > 0) {
                cumulativeEnergy += (dispatch * 1000 * price * duration);
                totalMWhGen += (dispatch * duration);
            } else if (dispatch < 0) {
                cumulativePumping += (Math.abs(dispatch) * 1000 * price * duration);
                totalMWhPump += (Math.abs(dispatch) * duration);
            }

            cumulativeAS += (capacityMW * 3.5 * duration);
            pshChart.data.datasets[0].data.push(price);
            pshChart.data.datasets[1].data.push(dispatch);
            pshChart.data.datasets[2].data.push(nonFitGet);

            currentInterval++;
            updateUI(price, dispatch);
            pshChart.update('none');
            updateAuditDashboard();
        }

        function updateAuditDashboard() {
            // SECTION: PSH CORE
            const physicalRte = totalMWhPump > 0 ? (totalMWhGen / totalMWhPump) : 0;
            document.getElementById('auditRTE').innerText = `${(physicalRte * 100).toFixed(1)}%`;
            const rteStatus = document.getElementById('rteStatus');
            if (physicalRte >= 0.75) { rteStatus.innerText = "‚úÖ Compliance Met (Physical)"; rteStatus.style.color = "var(--success)"; }
            else { rteStatus.innerText = "‚ö†Ô∏è Under Efficiency Benchmark"; rteStatus.style.color = "var(--danger)"; }

            const avgPrice = HISTORICAL_PRICES[currentYear] || 5;
            const rampRateStatus = (Math.abs(pshChart.data.datasets[1].data[currentInterval - 1] - pshChart.data.datasets[1].data[currentInterval - 2] || 0) > (capacityMW * 0.5)) ? "HIGH" : "NORMAL";
            document.getElementById('auditPumpingRisk').innerText = rampRateStatus;
            document.getElementById('auditPumpingRisk').style.color = (rampRateStatus === "NORMAL") ? "var(--success)" : "var(--warning)";

            const asRevenueActual = cumulativeAS;
            const energyOppCost = (capacityMW * 1000 * (avgPrice * 0.5) * currentInterval * (5 / 60));
            document.getElementById('auditAS').innerText = (asRevenueActual > energyOppCost) ? "PASS" : "AUDIT REQUIRED";
            document.getElementById('auditAS').style.color = (asRevenueActual > energyOppCost) ? "var(--success)" : "var(--warning)";

            const cycleEndurance = (totalMWhGen + totalMWhPump) > (capacityMW * 24 * 0.5) ? "STRESSED" : "STABLE";
            document.getElementById('auditDischarge').innerText = cycleEndurance;
            document.getElementById('auditDischarge').style.color = (cycleEndurance === "STABLE") ? "var(--success)" : "var(--warning)";

            // SECTION: GEOTHERMAL
            const geoEff = (0.985 - ((1 - geoDerateLimit) * 0.1));
            document.getElementById('auditGeoEff').innerText = `${(geoEff * 100).toFixed(1)}%`;
            document.getElementById('auditGeoReliability').innerText = `${(geoDerateLimit * 100).toFixed(0)}%`;
            document.getElementById('auditGeoWhp').innerText = geoDerateLimit > 0.9 ? "OPTIMAL" : "STRESSED";
            document.getElementById('auditGeoWhp').style.color = geoDerateLimit > 0.9 ? "var(--success)" : "var(--warning)";
            document.getElementById('auditGeoNcg').innerText = `100%`; // Placeholder for reinjection

            // SECTION: IMPOUNDING
            const head = 112 + (hydReservoirLevel * 15);
            const headEff = (head / 127) * 100;
            document.getElementById('auditImpHead').innerText = `${headEff.toFixed(1)}%`;
            const util = impCumulativeMWh > 0 ? (impCumulativeMWh / (impCumulativeMWh + impCumulativeSpill)) : 0;
            document.getElementById('auditImpInflow').innerText = `${(Math.max(0, util) * 100).toFixed(1)}%`;
            document.getElementById('auditImpCascade').innerText = impCumulativeSpill > 0 ? "WARNING" : "PASS";
            document.getElementById('auditImpCascade').style.color = impCumulativeSpill > 0 ? "var(--warning)" : "var(--success)";
            document.getElementById('auditImpYield').innerText = (2.41 + (head - 112) * 0.02).toFixed(2);

            // SECTION: AGGREGATES
            const totalGenMWh = totalMWhGen + geoCumulativeMWh + impCumulativeMWh;
            const avoidedPeaker = totalGenMWh * 1000 * (15 - avgPrice);
            document.getElementById('auditPeaker').innerText = `‚Ç±${Math.max(0, avoidedPeaker).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

            const co2 = totalGenMWh * 0.7;
            document.getElementById('auditCO2').innerText = `${co2.toFixed(1)} tCO2`;

            const resilienceValue = (waterLevel / 100 * capacityMW * 4 + hydReservoirLevel * 150) * 20000;
            document.getElementById('auditVOLL').innerText = `‚Ç±${resilienceValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

            const synergy = 1.0 + (totalMWhGen > 0 ? 0.2 : 0) + (geoCumulativeMWh > 0 ? 0.35 : 0) + (impCumulativeMWh > 0 ? 0.25 : 0);
            document.getElementById('auditSynergy').innerText = synergy.toFixed(2);
        }

        function updateUI(price, dispatch) {
            if (price !== null) {
                document.getElementById('currentPrice').innerHTML = `‚Ç±${price.toFixed(2)}<small>/kWh</small>`;
                document.getElementById('currentDispatch').innerText = `${dispatch} MW`;
                document.getElementById('simTime').innerText = pshChart.data.labels[currentInterval - 1] + " H";

                const modeEl = document.getElementById('dispatchMode');
                if (dispatch > 0) { modeEl.innerText = "GENERATING"; modeEl.style.background = "#dcfce7"; modeEl.style.color = "#166534"; }
                else if (dispatch < 0) { modeEl.innerText = "PUMPING"; modeEl.style.background = "#dbeafe"; modeEl.style.color = "#1e40af"; }
                else { modeEl.innerText = "STANDBY"; modeEl.style.background = "#f1f5f9"; modeEl.style.color = "#64748b"; }
            }

            document.getElementById('waterLevel').style.height = `${waterLevel}%`;
            document.getElementById('waterPct').innerText = `${Math.round(waterLevel)}%`;

            const netCost = cumulativeGEA - cumulativeEnergy + cumulativePumping - cumulativeAS;
            // Socialize over monthly demand: (Daily Cost * 30 days) / (Monthly MWh * 1000)
            const ri = Math.max(0, netCost * 30) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);

            document.getElementById('netSettlement').innerText = `‚Ç±${Math.abs(netCost).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('rateImpact').innerHTML = `‚Ç±${ri.toFixed(4)}<small>/kWh</small>`;

            document.getElementById('breakdownGEA').innerText = `‚Ç±${cumulativeGEA.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('breakdownEnergy').innerText = `‚Ç±${cumulativeEnergy.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('breakdownPumping').innerText = `(‚Ç±${cumulativePumping.toLocaleString(undefined, { maximumFractionDigits: 0 })})`;
            document.getElementById('breakdownAS').innerText = `‚Ç±${cumulativeAS.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('breakdownTotal').innerText = `‚Ç±${netCost.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

            const badge = document.getElementById('verdictBadge');
            if (ri < 0.04) { badge.innerText = "GOOD"; badge.style.background = "#dcfce7"; badge.style.color = "#166534"; }
            else { badge.innerText = "MODERATE"; badge.style.background = "#fef3c7"; badge.style.color = "#92400e"; }


            const avoidedPeaker = totalMWhGen * 1000 * (15 - (HISTORICAL_PRICES[currentYear] || 5));
            document.getElementById('auditPeaker').innerText = `‚Ç±${Math.max(0, avoidedPeaker).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

            const voll = waterLevel * (capacityMW * 4) * 20000 / 100;
            document.getElementById('auditVOLL').innerText = `‚Ç±${voll.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

            const co2 = (cumulativeEnergy / 1000) * 0.7; // 0.7 tCO2 per MWh
            document.getElementById('auditCO2').innerText = `${co2.toFixed(2)} tCO2`;

        }

        function finalizeVerdict() {
            const netCost = cumulativeGEA - cumulativeEnergy + cumulativePumping - cumulativeAS;
            const ri = Math.max(0, netCost * 30) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);

            let title = ri < 0.04 ? "‚úÖ Consumer Friendly" : (ri < 0.10 ? "‚öñÔ∏è Fair Value" : "‚ö†Ô∏è High Cost Pressure");
            let body = `Analysis for ${PLANTS[currentPlant].name} (${currentYear} prices): The estimated rate impact is ‚Ç±${ri.toFixed(4)}/kWh. `;

            if (ri < 0.04) {
                body += "This is GOOD for consumers. The revenue from energy trading and ancillary services significantly mitigates the capacity payment cost.";
            } else {
                body += "The net cost is moderate. While it adds a small charge to the bill, the PSH provides critical grid stability and avoids more expensive peak generation.";
            }

            document.getElementById('verdictTitle').innerText = title;
            document.getElementById('verdictBody').innerText = body;
            document.getElementById('consumerVerdictCard').style.background = ri < 0.04 ? "#f0fdf4" : "#fffbeb";
            document.getElementById('consumerVerdictCard').style.borderColor = ri < 0.04 ? "#22c55e" : "#f59e0b";

            // Update Lifecycle Projection
            document.getElementById('projDaily').innerText = `‚Ç±${netCost.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('projMonthly').innerText = `‚Ç±${(netCost * 30).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('projAnnual').innerText = `‚Ç±${(netCost * 365).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('proj20Year').innerText = `‚Ç±${(netCost * 365 * 20).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        function switchTab(tabId) {
            // Hide/Show PSH specific controls
            const pshControls = document.getElementById('pshHeaderControls');
            const pshSelection = document.getElementById('pshSelectionBar');
            if (pshControls) pshControls.style.display = (tabId === 'simulator') ? 'flex' : 'none';
            if (pshSelection) pshSelection.style.display = (tabId === 'simulator') ? 'grid' : 'none';

            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });

            // Deactivate all tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show target content
            const target = document.getElementById(tabId);
            if (target) {
                target.style.display = 'block';
                // Trigger small delay for CSS transition
                setTimeout(() => target.classList.add('active'), 20);
            }

            // Activate corresponding tab button
            tabs.forEach(tab => {
                const btnOnclick = tab.getAttribute('onclick') || '';
                if (btnOnclick.includes(`'${tabId}'`)) {
                    tab.classList.add('active');
                }
            });

            // Handle suppression chart initialization
            if (tabId === 'suppression' && !suppressionChart20yr) {
                initSuppressionChart();
                updateSuppressionForecast('vre', 35); // Initialize with default VRE
                updateSuppressionForecast('fuel', 1.0); // Initialize with default Fuel
                updateDisplacementTable();
            }

            if (tabId === 'geothermal') {
                populateGeoTab();
                populateRoadmap('GEO');
            }
            if (tabId === 'impounding') {
                populateImpTab();
                populateRoadmap('IMP');
                initRainChartGened();
            }

            // Handle simulator chart resizing
            if (tabId === 'simulator' && pshChart) {
                pshChart.resize();
                pshChart.update();
            }
        }

        let rainChartGened = null;
        function initRainChartGened() {
            const canvas = document.getElementById('rainChartGened');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (rainChartGened) rainChartGened.destroy();

            rainChartGened = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Avg Rainfall (mm)',
                        data: [55, 45, 60, 95, 230, 310, 420, 450, 380, 290, 160, 85],
                        backgroundColor: (context) => {
                            const val = context.raw;
                            return val > 300 ? 'rgba(14, 165, 233, 0.6)' : 'rgba(14, 165, 233, 0.2)';
                        },
                        borderColor: '#0ea5e9',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, display: false },
                        x: { grid: { display: false }, ticks: { font: { size: 8 } } }
                    }
                }
            });
        }

        let stressScenario = 'baseline';
        function updateStressParam(type, val) {
            if (type === 'gea') {
                nonFitGet = parseFloat(val);
                document.getElementById('valGET').innerText = nonFitGet.toFixed(4);
            } else if (type === 'volatility') {
                const volVal = parseFloat(val);
                document.getElementById('valVol').innerText = volVal.toFixed(1);
                SEASONS.default.volatility = 1.1 * volVal;
            } else if (type === 'scenario') {
                stressScenario = val;
                const badge = document.getElementById('scenarioBadge');
                badge.innerText = val.charAt(0).toUpperCase() + val.slice(1);
                if (val === 'heatwave') {
                    SEASONS.default.volatility = 1.8;
                    document.getElementById('slideVol').value = 1.6;
                    document.getElementById('valVol').innerText = "1.6";
                } else if (val === 'el_nino') {
                    hydReservoirLevel = 0.3;
                    geoDerateLimit = 0.85;
                    SEASONS.default.volatility = 1.4;
                    document.getElementById('slideVol').value = 1.2;
                    document.getElementById('valVol').innerText = "1.2";
                    if (document.getElementById('slideGeoDerateTab')) document.getElementById('slideGeoDerateTab').value = 85;
                    if (document.getElementById('valGeoDerateTab')) document.getElementById('valGeoDerateTab').innerText = "85%";
                    if (document.getElementById('slideHydResTab')) document.getElementById('slideHydResTab').value = 30;
                    if (document.getElementById('valHydResTab')) document.getElementById('valHydResTab').innerText = "30%";
                } else if (val === 'baseline') {
                    SEASONS.default.volatility = 1.1;
                    document.getElementById('slideVol').value = 1.0;
                    document.getElementById('valVol').innerText = "1.0";
                    hydReservoirLevel = 0.8;
                    geoDerateLimit = 1.0;
                    if (document.getElementById('slideGeoDerateTab')) document.getElementById('slideGeoDerateTab').value = 100;
                    if (document.getElementById('valGeoDerateTab')) document.getElementById('valGeoDerateTab').innerText = "100%";
                    if (document.getElementById('slideHydResTab')) document.getElementById('slideHydResTab').value = 80;
                    if (document.getElementById('valHydResTab')) document.getElementById('valHydResTab').innerText = "80%";
                }
            } else if (type === 'derate') {
                pshDerateFactor = parseFloat(val) / 100;
                document.getElementById('valDerate').innerText = val + "%";
                document.getElementById('valDerateTab').innerText = val + "%";
                document.getElementById('valDerate').style.color = val < 100 ? 'var(--danger)' : 'var(--success)';
                document.getElementById('slideDerate').value = val;
                document.getElementById('slideDerateTab').value = val;
            } else if (type === 'geoderate') {
                geoDerateLimit = parseFloat(val) / 100;
                if (document.getElementById('valGeoDerateTab')) document.getElementById('valGeoDerateTab').innerText = val + "%";
                if (document.getElementById('slideGeoDerateTab')) document.getElementById('slideGeoDerateTab').value = val;
            } else if (type === 'hydres') {
                hydReservoirLevel = parseFloat(val) / 100;
                if (document.getElementById('valHydResTab')) document.getElementById('valHydResTab').innerText = val + "%";
                if (document.getElementById('slideHydResTab')) document.getElementById('slideHydResTab').value = val;
            } else if (type === 'scalar') {
                marketPriceScalar = parseFloat(val);
                document.getElementById('valScalar').innerText = marketPriceScalar.toFixed(1) + "x";
            } else if (type === 'delay') {
                globalProjectDelay = parseInt(val);
                document.getElementById('valDelay').innerText = val + " m";
            } else if (type === 'rateadj') {
                geaRateAdjustment = 1 + (parseFloat(val) / 100);
                document.getElementById('valRateAdj').innerText = (val > 0 ? "+" : "") + val + "%";
            }
            resetSim();
            updateSensitivityChart();
        }

        function toggleMustRun() {
            mustRunActive = !mustRunActive;
            const btn = document.getElementById('btnMustRun');
            btn.classList.toggle('active');
            btn.style.background = mustRunActive ? 'var(--primary)' : '';
            btn.style.color = mustRunActive ? '#fff' : '';
            updateSensitivityChart();
        }

        function toggleZonalLMP() {
            zonalLMPActive = !zonalLMPActive;
            const btn = document.getElementById('btnZonal');
            btn.classList.toggle('active');
            btn.style.background = zonalLMPActive ? 'var(--primary)' : '';
            btn.style.color = zonalLMPActive ? '#fff' : '';
            updateSensitivityChart();
        }

        let sensitivityChartInstance = null;
        function updateSensitivityChart() {
            const canvas = document.getElementById('sensitivityChart');
            if (!canvas) return;
            const ctxS = canvas.getContext('2d');
            const labels = [];
            const riData = [];
            const ciUpper = [];
            const ciLower = [];



            const p = PLANTS[currentPlant];
            const effectiveCap = p.capacity * pshDerateFactor;
            const hoursPerMonth = 30 * 24;
            const avgPrice = (HISTORICAL_PRICES[currentYear] || 5.0) * marketPriceScalar;
            const volatility = SEASONS.default.volatility;

            // Predictive Math if simulation hasn't run
            for (let i = 0; i <= 10; i++) {
                const testGea = 1.5 + (i * (8 - 1.5) / 10);
                labels.push(testGea.toFixed(1));

                const monthlyGEA = p.capacity * 1000 * testGea * hoursPerMonth;
                const injPrice = avgPrice * (zonalLMPActive ? 1.5 : 1.3);
                const pumpPrice = avgPrice * 0.7 * (1 / volatility);

                const monthlyEnergy = effectiveCap * 1000 * injPrice * (30 * 6);
                const monthlyPumping = effectiveCap * 1000 * pumpPrice * (30 * 6) * (mustRunActive ? 1.2 : 1.0);
                const monthlyAS = effectiveCap * 3.5 * hoursPerMonth;

                const net = monthlyGEA - (monthlyEnergy - monthlyPumping) - monthlyAS;
                const ri = Math.max(0, net) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);
                riData.push(ri.toFixed(4));
                ciUpper.push((ri * 1.15).toFixed(4));
                ciLower.push((ri * 0.85).toFixed(4));
            }

            const maxRI = Math.max(...riData);
            document.getElementById('stressMaxRI').innerText = `‚Ç±${parseFloat(maxRI).toFixed(4)}`;
            const prob = maxRI > 0.1 ? "‚ö†Ô∏è 65% PASS" : "‚úÖ 100% PASS";
            document.getElementById('complianceProb').innerText = prob;
            document.getElementById('complianceProb').style.color = maxRI > 0.1 ? 'var(--danger)' : 'var(--success)';

            // Compliance Probability Heuristic based on Rate Impact and Portfolio Stress
            const avgRI = riData.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / riData.length;
            const portfolioStress = (1 - geoDerateLimit) * 20 + (1 - hydReservoirLevel) * 30;
            const complianceProb = Math.max(0, 100 - (avgRI * 1500) - (mustRunActive ? 15 : 0) - (zonalLMPActive ? 10 : 0) - portfolioStress);

            document.getElementById('complianceProb').innerText = `${complianceProb.toFixed(0)}% AUDIT PASS PROB`;
            document.getElementById('complianceProb').style.color = complianceProb > 70 ? 'var(--success)' : (complianceProb > 40 ? 'var(--warning)' : 'var(--danger)');

            document.getElementById('stressMaxRI').innerText = `‚Ç±${parseFloat(ciUpper[ciUpper.length - 1]).toFixed(4)}`;

            if (sensitivityChartInstance) sensitivityChartInstance.destroy();
            sensitivityChartInstance = new Chart(ctxS, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Rate Impact (‚Ç±/kWh)',
                            data: riData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4,
                            z: 10
                        },
                        {
                            label: '95% CI Zone',
                            data: ciUpper,
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(37, 99, 235, 0.05)',
                            fill: '+1',
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Lower Bound',
                            data: ciLower,
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(37, 99, 235, 0.05)',
                            fill: false,
                            pointRadius: 0,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'GEA Rate (PhP/kW)', font: { size: 8 } }, ticks: { font: { size: 7 } } },
                        y: { title: { display: true, text: 'Impact', font: { size: 8 } }, ticks: { font: { size: 7 } }, min: 0 }
                    }
                }
            });
        }



        let roadmapChartInstance = null;
        let roadmapChartGeo = null;
        let roadmapChartImp = null;

        function populateRoadmap(type = 'PSH') {
            const bodyId = type === 'PSH' ? 'roadmapTableBody' : (type === 'GEO' ? 'roadmapTableBodyGeo' : 'roadmapTableBodyImp');
            const canvasId = type === 'PSH' ? 'roadmapChart' : (type === 'GEO' ? 'roadmapChartGeo' : 'roadmapChartImp');

            const body = document.getElementById(bodyId);
            if (!body) return;
            body.innerHTML = '';

            const avgPrice = 3.80; // Baseline market price for settlement delta calculation
            const pumpPrice = avgPrice * 0.8;
            const injPrice = avgPrice * 1.5;
            const hoursPerMonth = 30 * 24;

            const years = [];
            const capacities = [];
            const unitCounts = [];
            const impacts = [];

            const startY = type === 'GEO' ? 2025 : 2028;

            for (let year = startY; year <= 2045; year++) {
                let pshRI = 0, geoRI = 0, impRI = 0;
                let totalActiveCap = 0;
                let activeCount = 0;

                // Advanced 20-Year Factors
                const yearsPassed = year - 2025;
                const whpDecline = Math.pow(0.992, yearsPassed); // 0.8% decline per year
                const siltationFactor = Math.pow(0.998, yearsPassed); // 0.2% loss per year

                Object.values(PLANTS).forEach(p => {
                    const effectiveStartYear = p.startYear + Math.floor(globalProjectDelay / 12);
                    const delayedYearFraction = (globalProjectDelay % 12) / 12;

                    if (year >= effectiveStartYear) {
                        // Rough check for fractional delay impact in the COD year
                        let availabilityFactor = 1.0;
                        if (year === effectiveStartYear) availabilityFactor = 1 - delayedYearFraction;

                        const effectiveRate = p.rate * geaRateAdjustment;
                        activeCount++;

                        if (p.type === 'PSH') {
                            totalActiveCap += p.capacity * availabilityFactor;
                            const monthlyGEA = (p.capacity * availabilityFactor) * 1000 * effectiveRate * hoursPerMonth;
                            const monthlyEnergy = (p.capacity * availabilityFactor) * 1000 * injPrice * (30 * 6);
                            const monthlyPumping = (p.capacity * availabilityFactor) * 1000 * pumpPrice * (30 * 6);
                            const monthlyAS = (p.capacity * availabilityFactor) * 3.5 * hoursPerMonth;
                            const netSettlement = monthlyGEA - (monthlyEnergy - monthlyPumping) - monthlyAS;
                            pshRI += Math.max(0, netSettlement) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);
                        } else if (p.type === 'GEO') {
                            const actualCap = p.capacity * whpDecline * availabilityFactor;
                            totalActiveCap += actualCap;
                            const monthlyGEA = actualCap * 1000 * effectiveRate * hoursPerMonth;
                            const monthlyMkt = actualCap * 1000 * avgPrice * hoursPerMonth;
                            geoRI += Math.max(0, monthlyGEA - monthlyMkt) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);
                        } else if (p.type === 'IMP') {
                            const actualCap = p.capacity * siltationFactor * availabilityFactor;
                            totalActiveCap += actualCap;
                            const monthlyGEA = actualCap * 1000 * effectiveRate * hoursPerMonth;
                            const monthlyMkt = actualCap * 1000 * avgPrice * hoursPerMonth;
                            impRI += Math.max(0, monthlyGEA - monthlyMkt) / (SYSTEM_DEMAND_MONTHLY_MWH * 1000);
                        }
                    }
                });

                const totalPortfolioRI = pshRI + geoRI + impRI;

                if (activeCount > 0) {
                    years.push(year);
                    capacities.push(totalActiveCap);
                    impacts.push(parseFloat(totalPortfolioRI.toFixed(4)));

                    let rowHtml = `<td><strong>${year}</strong></td>`;
                    rowHtml += `<td style="color:#2563eb">‚Ç±${pshRI.toFixed(4)}</td>`;
                    rowHtml += `<td style="color:#8b5cf6">‚Ç±${geoRI.toFixed(4)}</td>`;
                    rowHtml += `<td style="color:#0ea5e9">‚Ç±${impRI.toFixed(4)}</td>`;
                    rowHtml += `<td style="text-align: right; font-weight: 800; color: var(--primary);">‚Ç±${totalPortfolioRI.toFixed(4)}</td>`;
                    body.innerHTML += `<tr>${rowHtml}</tr>`;
                }
            }

            const ctx = document.getElementById(canvasId).getContext('2d');
            let instance;
            if (type === 'PSH') instance = roadmapChartInstance;
            else if (type === 'GEO') instance = roadmapChartGeo;
            else instance = roadmapChartImp;

            if (instance) instance.destroy();

            const newInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Total Rate Impact (‚Ç±/kWh)',
                            data: impacts,
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Total GEA3 Portfolio (MW)',
                            data: capacities,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10b981',
                            type: 'bar',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { title: { display: true, text: '‚Ç±/kWh' }, position: 'left' },
                        y1: { title: { display: true, text: 'MW' }, position: 'right', grid: { display: false } }
                    }
                }
            });

            if (type === 'PSH') roadmapChartInstance = newInstance;
            else if (type === 'GEO') roadmapChartGeo = newInstance;
            else roadmapChartImp = newInstance;
        }

        function toggleSim() {
            isSimulating = !isSimulating;
            const btn = document.getElementById('playBtn');
            if (isSimulating) {
                btn.innerText = "Stop Simulation";
                btn.style.background = "var(--danger)";
                simInterval = setInterval(step, 40);
            } else {
                btn.innerText = "Resume Simulation";
                btn.style.background = "var(--primary)";
                clearInterval(simInterval);
            }
        }

        // WESM Price Suppression Chart Logic
        let suppressionChart20yr = null;
        let vrePenetration = 0.35;
        let fuelTrend = 1.0;

        function initSuppressionChart() {
            const canvas = document.getElementById('suppression20YearChart');
            if (!canvas) return;
            const ctxS = canvas.getContext('2d');
            if (suppressionChart20yr) suppressionChart20yr.destroy();

            const labels = Array.from({ length: 21 }, (_, i) => 2025 + i);
            suppressionChart20yr = new Chart(ctxS, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Baseline (Without GEA3)',
                            data: generateSuppressionData('baseline'),
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.05)',
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'After Geothermal',
                            data: generateSuppressionData('geo'),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'After Impounding',
                            data: generateSuppressionData('hyd'),
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'After PSH (Portfolio Total)',
                            data: generateSuppressionData('total'),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.15)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3,
                            pointBackgroundColor: '#2563eb'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { grid: { color: '#f1f5f9' }, title: { display: true, text: 'Expected WESM Price (‚Ç±/kWh)', font: { size: 10 } }, min: 3 },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function generateSuppressionData(layer) {
            const data = [];
            // Regulatory forecast standard: Use 'Real Price' (flat curve in today's pesos) instead of nominal inflation.
            // Anchored to the 2025 YTD GWAP Baseline (3.81)
            let basePrice = 3.81 * fuelTrend;
            for (let i = 0; i <= 20; i++) {
                // VRE Volatility premium: as RE penetration climbs linearly, duck-curve scarcity pricing emerges in the evening
                const vreVol = (vrePenetration * 1.5 * i / 20);
                let price = basePrice + vreVol;

                let benefit = 0;
                const geoBen = (geoPenetration / 1000 * 0.4) * (i > 2 ? 1 : 0);
                const hydBen = (hydPenetration / 1000 * 0.6) * (i > 4 ? 1 : 0);
                const pshBen = (0.5 + vrePenetration * 2.5) * (i > 5 ? 1.2 : 0.6);

                if (layer === 'geo') benefit = geoBen;
                if (layer === 'hyd') benefit = geoBen + hydBen;
                if (layer === 'total') benefit = geoBen + hydBen + pshBen;

                price -= benefit;
                data.push(Math.max(3.8, price));
            }
            return data;
        }

        // Conventional Asset Displacement Logic
        const CONVENTIONAL_PLANTS = [
            { name: "Malaya Thermal Units 1 & 2", type: "Oil/Bunker", region: "Luzon", role: "Peaker / MRU", cap: 650, rate: 18.50 },
            { name: "Ilijan Natural Gas Plant", type: "Natural Gas", region: "Luzon", role: "Mid-Merit / Baseload", cap: 1200, rate: 8.50 },
            { name: "Sual Coal Unit 1 (Aging)", type: "Coal", region: "Luzon", role: "Baseload", cap: 600, rate: 5.80 },
            { name: "Team Energy Sual Unit 2", type: "Coal", region: "Luzon", role: "Baseload", cap: 600, rate: 5.85 },
            { name: "GNPower Mariveles", type: "Coal", region: "Luzon", role: "Baseload", cap: 600, rate: 6.10 },
            { name: "Pagbilao Unit 1 & 2", type: "Coal", region: "Luzon", role: "Baseload", cap: 700, rate: 6.20 },
            { name: "Pagbilao Unit 3", type: "Coal", region: "Luzon", role: "Mid-Merit", cap: 420, rate: 6.40 },
            { name: "Quezon Power (Old)", type: "Coal", region: "Luzon", role: "Baseload", cap: 460, rate: 6.25 },
            { name: "SMC Limay Coal", type: "Coal", region: "Luzon", role: "Baseload", cap: 600, rate: 6.00 },
            { name: "Masinloc Unit 1 & 2 (Old)", type: "Coal", region: "Luzon", role: "Mid-Merit", cap: 600, rate: 6.45 },
            { name: "Masinloc Unit 3", type: "Coal", region: "Luzon", role: "Mid-Merit", cap: 335, rate: 6.30 },
            { name: "Calaca Unit 1 & 2 (Aging)", type: "Coal", region: "Luzon", role: "Baseload", cap: 600, rate: 6.15 },
            { name: "Sta. Rita Gas Plant", type: "Natural Gas", region: "Luzon", role: "Mid-Merit", cap: 500, rate: 8.75 },
            { name: "San Lorenzo Gas Plant", type: "Natural Gas", region: "Luzon", role: "Mid-Merit", cap: 500, rate: 8.90 },
            { name: "Therma South Mindanao", type: "Coal", region: "Mindanao", role: "Baseload", cap: 300, rate: 5.90 },
            { name: "Cebu Energy (CEDC)", type: "Coal", region: "Visayas", role: "Baseload", cap: 246, rate: 6.35 },
            { name: "Naga Complex (Oil)", type: "Diesel", region: "Visayas", role: "Peaker / AS", cap: 100, rate: 22.40 },
            { name: "Limay Diesel Plant", type: "Bunker C", region: "Luzon", role: "Peak Load", cap: 110, rate: 19.80 },
            { name: "Bauang Diesel (1590)", type: "Diesel", region: "Luzon", role: "Peaking", cap: 215, rate: 17.60 },
            { name: "Toledo Power (Old)", type: "Oil/Bunker", region: "Visayas", role: "Peaking", cap: 82, rate: 18.20 },
            { name: "Power Barge 101-104", type: "Diesel", region: "Vis/Min", role: "Emergency / AS", cap: 128, rate: 25.10 },
            { name: "Mobile Diesel Units (GenSets)", type: "Diesel", region: "National", role: "Emergency / AS", cap: 200, rate: 24.50 }
        ];

        function updateDisplacementTable() {
            const body = document.getElementById('displacedPlantsBody');
            if (!body) return;
            body.innerHTML = '';
            let totalCO2e = 0;

            CONVENTIONAL_PLANTS.forEach(plant => {
                // Heuristic displacement logic based on VRE penetration and Fuel Trends
                let baseRisk = (plant.type.includes("Oil") || plant.type.includes("Diesel") || plant.type.includes("Bunker")) ? 65 : 15;
                let fuelMultiplier = plant.type.includes("Coal") ? (fuelTrend * 5) : (fuelTrend * 15);
                let vreImpact = vrePenetration * 45;
                let portfolioImpact = (geoPenetration / 100) + (hydPenetration / 400) * 15;

                let probability = Math.min(99, baseRisk + fuelMultiplier + vreImpact + portfolioImpact);
                if (plant.role === "Baseload") probability = Math.min(60, (vrePenetration * 80) + (geoPenetration / 5));

                let annualMWh = plant.cap * 1460 * (probability / 100);
                let factor = plant.type.includes("Coal") ? 0.98 : (plant.type.includes("Natural Gas") ? 0.42 : 0.7);
                totalCO2e += (annualMWh * factor * 20); // 20 year lifecycle

                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';
                tr.innerHTML = `
                    <td style="padding: 0.75rem;"><strong>${plant.name}</strong><br><small style="color:var(--text-muted)">${plant.region}</small></td>
                    <td style="padding: 0.75rem;">${plant.type}</td>
                    <td style="padding: 0.75rem;">${plant.role}</td>
                    <td style="padding: 0.75rem; text-align: center;">${plant.cap} MW</td>
                    <td style="padding: 0.75rem; text-align: center;">‚Ç±${plant.rate.toFixed(2)}</td>
                    <td style="padding: 0.75rem; text-align: right;">
                        <span class="feature-badge" style="background: ${probability > 60 ? '#fef2f2' : '#f0fdf4'}; color: ${probability > 60 ? '#991b1b' : '#166534'};">
                            ${probability.toFixed(0)}% Displaced
                        </span>
                    </td>
                `;
                body.appendChild(tr);
            });

            const co2Elem = document.getElementById('co2Tracker');
            if (co2Elem) co2Elem.innerText = `${(totalCO2e / 1e6).toFixed(2)} M Metric Tons (tCO2e)`;
        }

        function updateSuppressionForecast(type, val) {
            if (type === 'vre') {
                vrePenetration = parseFloat(val) / 100;
                document.getElementById('valVRE').innerText = val + "%";
            } else if (type === 'fuel') {
                fuelTrend = parseFloat(val);
                document.getElementById('valFuel').innerText = val + "x";
            } else if (type === 'geo') {
                geoPenetration = parseFloat(val);
                document.getElementById('valGeoPen').innerText = val + "MW";
            } else if (type === 'hyd') {
                hydPenetration = parseFloat(val);
                document.getElementById('valHydPen').innerText = val + "MW";
            } else if (type === 'psh') {
                pshPenetration = parseFloat(val);
                document.getElementById('valPshPen').innerText = val + "MW";
            }
            if (duckCurveChart && type === 'vre') updateDuckCurve();
            if (suppressionChart20yr) {
                suppressionChart20yr.data.datasets[0].data = generateSuppressionData('baseline');
                suppressionChart20yr.data.datasets[1].data = generateSuppressionData('geo');
                suppressionChart20yr.data.datasets[2].data = generateSuppressionData('hyd');
                suppressionChart20yr.data.datasets[3].data = generateSuppressionData('total');
                suppressionChart20yr.update();

                const baseline = suppressionChart20yr.data.datasets[0].data;
                const total = suppressionChart20yr.data.datasets[3].data;
                const geoL = suppressionChart20yr.data.datasets[1].data;
                const hydL = suppressionChart20yr.data.datasets[2].data;

                let totalDelta = 0;
                let geoDelta = 0;
                let hydDelta = 0;
                let pshDelta = 0;

                baseline.forEach((v, i) => {
                    geoDelta += (v - geoL[i]);
                    hydDelta += (geoL[i] - hydL[i]);
                    pshDelta += (hydL[i] - total[i]);
                    totalDelta += (v - total[i]);
                });

                // Convert total portfolio dispatch savings into 20-year net present value
                const totalCapKW = (pshPenetration + geoPenetration + hydPenetration) * 1000;
                const activeHoursPerYear = 1460; // Assumed dispatch at peak for 4 hours a day
                const savingsBase = (totalCapKW * activeHoursPerYear * 20) / 1e9; // Output directly in Billions Php

                document.getElementById('totalSavings20yr').innerText = `‚Ç±${(totalDelta * savingsBase).toFixed(1)} Billion`;
                document.getElementById('savingsPSH').innerText = `‚Ç±${(pshDelta * savingsBase).toFixed(1)} B`;
                document.getElementById('savingsGeo').innerText = `‚Ç±${(geoDelta * savingsBase).toFixed(1)} B`;
                document.getElementById('savingsHyd').innerText = `‚Ç±${(hydDelta * savingsBase).toFixed(1)} B`;

                updateDisplacementTable();
            }
        }

        // GEA3 Geothermal & Impounding Logic
        function populateGeoTab() {
            const grid = document.getElementById('geoGrid');
            grid.innerHTML = '';
            Object.values(PLANTS).filter(p => p.type === 'GEO').forEach(p => {
                grid.innerHTML += `
                    <div class="audit-card" style="background:#fff; border: 1px solid var(--border-color); padding: 1.25rem;">
                        <h4 style="color:#8b5cf6;">${p.name}</h4>
                        <p style="font-size:0.75rem; color:var(--text-muted);">${p.developer}</p>
                        <div style="font-size:1.1rem; font-weight:700; margin:0.5rem 0;">${p.capacity} MW</div>
                        <div style="font-size:0.7rem; color:var(--primary);">Bid: ‚Ç±${p.rate.toFixed(4)}/kWh</div>
                    </div>
                `;
            });
            initGeoChart();
        }

        function populateImpTab() {
            const grid = document.getElementById('impoundGrid');
            if (!grid) return;
            grid.innerHTML = '';
            Object.values(PLANTS).filter(p => p.type === 'IMP').forEach(p => {
                grid.innerHTML += `
                    <div style="background:white; padding:1.5rem; border-radius:1rem; border:1px solid var(--border-color); box-shadow:var(--shadow-sm); position:relative; overflow:hidden;">
                        <span style="position:absolute; top:0; left:0; height:4px; width:100%; background:#0ea5e9;"></span>
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <h4 style="color:#0ea5e9; font-size:1.1rem;">${p.name}</h4>
                                <div style="font-size:0.7rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; margin-top:0.25rem;">Developer: ${p.developer}</div>
                            </div>
                            <div style="background:#f0f9ff; color:#0ea5e9; padding:0.25rem 0.6rem; border-radius:0.5rem; font-weight:800; font-size:0.8rem;">
                                ${p.capacity} MW
                            </div>
                        </div>
                        <div style="margin-top:1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                            <div style="background:#f8fafc; padding:0.75rem; border-radius:0.5rem; border:1px solid #f1f5f9;">
                                <div style="font-size:0.6rem; color:var(--text-muted); font-weight:600;">GEA RATE</div>
                                <div style="font-size:0.9rem; font-weight:800; color:var(--text-dark);">‚Ç±${p.rate.toFixed(4)}</div>
                            </div>
                            <div style="background:#f8fafc; padding:0.75rem; border-radius:0.5rem; border:1px solid #f1f5f9;">
                                <div style="font-size:0.6rem; color:var(--text-muted); font-weight:600;">GEA LOT</div>
                                <div style="font-size:0.9rem; font-weight:800; color:var(--text-dark);">${p.lot}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            initImpChart();
        }

        function initGeoChart() {
            const ctx = document.getElementById('geoChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mid 3', 'Tanawon', 'Bago'],
                    datasets: [{
                        label: 'GEA3 Bid Rate (‚Ç±/kWh)',
                        data: [5.0512, 4.8821, 5.2210],
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const revCtx = document.getElementById('geoRevenueChart').getContext('2d');
            if (geoRevenueChart) geoRevenueChart.destroy();
            geoRevenueChart = new Chart(revCtx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 96 }, (_, i) => {
                        let h = Math.floor(i / 4);
                        let m = (i % 4) * 15;
                        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    }),
                    datasets: [
                        {
                            label: 'WESM Price (‚Ç±/kWh)',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3, pointRadius: 0, fill: true
                        },
                        {
                            label: 'Accrued Revenue (‚Ç±)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3, pointRadius: 0, fill: true
                        },
                        {
                            label: 'GEAP Bid (LCOE)',
                            data: [],
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            yAxisID: 'y',
                            tension: 0, pointRadius: 0, fill: false
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { title: { display: true, text: 'Price (‚Ç±/kWh)' }, position: 'left' },
                        y1: { title: { display: true, text: 'Revenue (‚Ç±)' }, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function initImpChart() {
            const ctx = document.getElementById('impoundChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Mar', 'Jun', 'Sep', 'Dec'],
                    datasets: [{
                        label: 'Typical Gened Inflow (m3/s)',
                        data: [40, 30, 120, 200, 80],
                        borderColor: '#0ea5e9',
                        fill: false
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const revCtx = document.getElementById('impRevenueChart').getContext('2d');
            if (impRevenueChart) impRevenueChart.destroy();
            impRevenueChart = new Chart(revCtx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 96 }, (_, i) => {
                        let h = Math.floor(i / 4);
                        let m = (i % 4) * 15;
                        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    }),
                    datasets: [
                        {
                            label: 'WESM Price (‚Ç±/kWh)',
                            data: [],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3, pointRadius: 0, fill: true
                        },
                        {
                            label: 'Accrued Revenue (‚Ç±)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3, pointRadius: 0, fill: true
                        },
                        {
                            label: 'GEAP Bid (LCOE)',
                            data: [],
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            yAxisID: 'y',
                            tension: 0, pointRadius: 0, fill: false
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { maxTicksLimit: 12, font: { size: 8 } } },
                        y: { title: { display: true, text: 'Price (‚Ç±/kWh)', font: { size: 9 } }, position: 'left', ticks: { font: { size: 8 } } },
                        y1: { title: { display: true, text: 'Revenue (‚Ç±)', font: { size: 9 } }, position: 'right', grid: { display: false }, ticks: { font: { size: 8 } } }
                    }
                }
            });
        }

        // 15-Minute Cycle Simulators
        function toggleGeoSim() {
            isGeoSimulating = !isGeoSimulating;
            const btn = document.getElementById('playBtnGeo');
            if (isGeoSimulating) {
                if (geoCurrentInterval >= 96) resetGeoSim();
                btn.innerText = "Stop Baseload Cycle";
                geoSimInterval = setInterval(geoStep, 100);
            } else {
                btn.innerText = "Start Baseload Cycle";
                clearInterval(geoSimInterval);
            }
        }

        function resetGeoSim() {
            isGeoSimulating = false;
            clearInterval(geoSimInterval);
            document.getElementById('playBtnGeo').innerText = "Start Baseload Cycle";
            geoCumulativeRev = 0;
            geoCurrentInterval = 0;
            geoCumulativeMWh = 0;
            document.getElementById('geoRev').innerText = "‚Ç±0";
            document.getElementById('geoSimTime').innerText = "00:00 H";
            if (geoRevenueChart) {
                geoRevenueChart.data.datasets[0].data = [];
                geoRevenueChart.data.datasets[1].data = [];
                if (geoRevenueChart.data.datasets[2]) geoRevenueChart.data.datasets[2].data = [];
                geoRevenueChart.update();
            }
        }

        function geoStep() {
            const todFactor = Math.sin((geoCurrentInterval / 96) * Math.PI * 2 - Math.PI / 2) * 0.5 + 0.5; // Peak at noon
            const ambientTemp = 28 + todFactor * 10; // 28C to 38C
            const ambDerate = Math.max(0, (ambientTemp - 30) * 0.005); // 0.5% loss per degree above 30C

            const price = (5 + Math.random() * 4) * marketPriceScalar;
            const cap = geoPenetration * geoDerateLimit * (1 - ambDerate);
            const temp = 305 + Math.random() * 25;
            const efficiency = 0.985 - ((temp - 305) / 1200);

            geoCumulativeRev += (cap * 1000 * price * (15 / 60)) * efficiency;
            geoCumulativeMWh += (cap * 1000 * (15 / 60)) / 1000;

            if (geoRevenueChart) {
                if (geoCurrentInterval === 0) {
                    geoRevenueChart.data.datasets[0].data = [];
                    geoRevenueChart.data.datasets[1].data = [];
                    if (geoRevenueChart.data.datasets[2]) geoRevenueChart.data.datasets[2].data = [];
                }
                const lcoeGeo = 5.0512;
                geoRevenueChart.data.datasets[0].data.push(price);
                geoRevenueChart.data.datasets[1].data.push(geoCumulativeRev);
                if (geoRevenueChart.data.datasets[2]) geoRevenueChart.data.datasets[2].data.push(lcoeGeo);
                geoRevenueChart.update('none');
                document.getElementById('geoSimTime').innerText = geoRevenueChart.data.labels[geoCurrentInterval] + " H";
            }

            geoCurrentInterval = (geoCurrentInterval + 1) % 96;

            const whp = 180 + Math.random() * 40;
            const brine = 1500 + Math.random() * 300;
            const ncg = 0.5 + Math.random() * 0.8;
            const ent = 2750 + Math.random() * 100;

            document.getElementById('geoRev').innerText = `‚Ç±${geoCumulativeRev.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('geoTemp').innerText = `${temp.toFixed(1)}¬∞C`;
            document.getElementById('geoEff').innerText = `${(efficiency * 100).toFixed(1)}%`;
            document.getElementById('geoStatus').innerText = geoDerateLimit < 0.95 ? "PARTIAL DERATE" : "OPTIMAL BASELOAD";
            document.getElementById('geoStatus').style.color = geoDerateLimit < 0.95 ? "var(--warning)" : "#10b981";

            if (document.getElementById('geoWhp')) {
                document.getElementById('geoWhp').innerText = `${whp.toFixed(0)} psi`;
                document.getElementById('geoBrine').innerText = `${brine.toFixed(0)} m¬≥/h`;
                document.getElementById('geoNcg').innerText = `${ncg.toFixed(2)}%`;
                document.getElementById('geoEnt').innerText = `${ent.toFixed(0)} kJ/kg`;

                document.getElementById('geoAmbDerate').innerText = `${(ambDerate * 100).toFixed(1)}%`;
                document.getElementById('geoFlashEff').innerText = `${(88 + Math.random() * 4).toFixed(1)}%`;
                document.getElementById('geoNcgLoad').innerText = `${(cap * 0.04).toFixed(2)} MW`;
                document.getElementById('geoMakeupWells').innerText = `${Math.floor(geoCurrentInterval / 960)} Units`; // Simulated
            }
            updateAuditDashboard();
        }

        function toggleImpSim() {
            isImpSimulating = !isImpSimulating;
            const btn = document.getElementById('playBtnImp');
            if (isImpSimulating) {
                btn.innerText = "Stop Hydro Cycle";
                impSimInterval = setInterval(impStep, 100);
            } else {
                btn.innerText = "Start Hydro Cycle";
                clearInterval(impSimInterval);
            }
        }

        function resetImpSim() {
            isImpSimulating = false;
            clearInterval(impSimInterval);
            document.getElementById('playBtnImp').innerText = "Start Hydro Cycle";
            impCumulativeRev = 0;
            impCurrentInterval = 0;
            document.getElementById('impRev').innerText = "‚Ç±0";
            if (impRevenueChart) {
                impRevenueChart.data.datasets[0].data = [];
                impRevenueChart.data.datasets[1].data = [];
                if (impRevenueChart.data.datasets[2]) impRevenueChart.data.datasets[2].data = [];
                impRevenueChart.update();
            }
        }

        function impStep() {
            if (impCurrentInterval >= 96) {
                toggleImpSim();
                return;
            }
            const price = (4 + Math.random() * 7) * marketPriceScalar;
            const cap = hydPenetration;

            // Cascading Logic: Gened 2 inflow depends on Gened 1 discharge delay
            const gened1Discharge = (75 + Math.random() * 30) * hydReservoirLevel;
            gened1DischargeHistory.push(gened1Discharge);
            if (gened1DischargeHistory.length > 32) gened1DischargeHistory.shift();

            const delayedInflow = gened1DischargeHistory[0]; // 8-interval lag (2 hours)
            const inflow = (delayedInflow + Math.random() * 20) * hydReservoirLevel;

            const spillage = Math.max(0, inflow - 110);
            const head = 112 + (hydReservoirLevel * 15);

            const isMidMerit = price > 7.5;
            const dispatchMW = isMidMerit ? cap : cap * 0.12;

            impCumulativeRev += (dispatchMW * 1000 * price * (15 / 60));
            impCumulativeMWh += (dispatchMW * (15 / 60));
            impCumulativeSpill += (spillage * (15 / 60));

            const gate = isMidMerit ? (85 + Math.random() * 10) : (15 + Math.random() * 10);
            const tail = 10.2 + (dispatchMW / cap) * 2.5;
            const velocity = (dispatchMW / cap) * 6.5;
            const yieldVal = 2.4 + (head - 112) * 0.02;

            document.getElementById('impRev').innerText = `‚Ç±${impCumulativeRev.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            document.getElementById('impHead').innerText = `${head.toFixed(1)}m`;
            document.getElementById('impInflow').innerText = `${inflow.toFixed(0)} m¬≥/s`;
            document.getElementById('impSpill').innerText = `${spillage.toFixed(1)} m¬≥/s`;
            updateAuditDashboard();
            document.getElementById('impMode').innerText = isMidMerit ? "PEAK DISCHARGE" : "RESERVOIR FILL";
            document.getElementById('impMode').style.color = isMidMerit ? "#0ea5e9" : "#059669";

            if (impRevenueChart) {
                if (impCurrentInterval === 0) {
                    impRevenueChart.data.datasets[0].data = [];
                    impRevenueChart.data.datasets[1].data = [];
                    if (impRevenueChart.data.datasets[2]) impRevenueChart.data.datasets[2].data = [];
                }
                const lcoeImp = 5.38; // Estimate average GEA3 impounding rate
                impRevenueChart.data.datasets[0].data.push(price);
                impRevenueChart.data.datasets[1].data.push(impCumulativeRev);
                if (impRevenueChart.data.datasets[2]) impRevenueChart.data.datasets[2].data.push(lcoeImp);
                impRevenueChart.update('none');
                document.getElementById('impSimTime').innerText = impRevenueChart.data.labels[impCurrentInterval] + " H";
            }

            impCurrentInterval++;

            if (document.getElementById('impGate')) {
                document.getElementById('impGate').innerText = `${gate.toFixed(1)}%`;
                document.getElementById('impTail').innerText = `${tail.toFixed(1)}m`;
                document.getElementById('impYield').innerText = `${yieldVal.toFixed(2)} kWh/m¬≥`;
                document.getElementById('impVel').innerText = `${velocity.toFixed(1)} m/s`;

                document.getElementById('impCascadingLag').innerText = `120 min`;
                document.getElementById('impSiltation').innerText = `${(0.4).toFixed(1)}%`;
                document.getElementById('impHydRecov').innerText = `${(92 + Math.random() * 3).toFixed(1)}%`;
                document.getElementById('impSpillLoss').innerText = `${(spillage * 0.15).toFixed(2)} MWh`;
            }
        }



        function updateDisplacementHeatmap() {
            const container = document.getElementById('displacementHeatmap');
            if (!container) return;
            container.innerHTML = '';

            for (let h = 0; h < 24; h++) {
                const cell = document.createElement('div');
                const isPeak = (h >= 10 && h <= 15) || (h >= 18 && h <= 21);
                const opacity = 0.3 + Math.random() * 0.7;
                // Peak displacement is Reddish-Pink, Off-peak is Deep Blue
                const color = isPeak ? `rgba(244, 63, 94, ${opacity})` : `rgba(37, 99, 235, ${opacity})`;

                cell.style.background = color;
                cell.style.borderRadius = '2px';
                cell.style.cursor = 'help';
                cell.title = `Hour ${h}:00 - Fossil Displacement: ${(opacity * 100).toFixed(0)}%`;
                container.appendChild(cell);
            }
        }

        function updateDuckCurve() {
            if (!duckCurveChart) return;
            duckCurveChart.data.datasets[0].data = Array.from({ length: INTERVALS }, (_, i) => {
                let baseLoad = 12000 + Math.sin((i / INTERVALS) * Math.PI * 2 - Math.PI / 2) * 2000;
                let peakLoad = (i > 192 && i < 240) ? 1500 : 0; // 4pm - 8pm localized Peak
                let solarOff = (i > 72 && i < 200) ? Math.sin((i - 72) / 128 * Math.PI) * (4000 * (vrePenetration / 0.35)) : 0;
                return baseLoad + peakLoad - solarOff;
            });
            duckCurveChart.data.datasets[1].data = Array.from({ length: INTERVALS }, (_, i) => {
                return (i > 72 && i < 200) ? Math.sin((i - 72) / 128 * Math.PI) * (4000 * (vrePenetration / 0.35)) : 0;
            });
            duckCurveChart.update();
        }

        let duckCurveChart = null;
        function initDuckCurve() {
            const duckCtx = document.getElementById('duckCurveChart');
            if (!duckCtx) return;
            duckCurveChart = new Chart(duckCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array.from({ length: INTERVALS }, (_, i) => {
                        let h = Math.floor(i / 12);
                        let m = (i % 12) * 5;
                        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    }),
                    datasets: [
                        {
                            label: 'System Net Load (MW)',
                            data: [],
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.2)',
                            fill: true, tension: 0.4, pointRadius: 0
                        },
                        {
                            label: 'Solar Gen (Duck Belly Factor)',
                            data: [],
                            borderColor: '#facc15',
                            borderDash: [5, 5],
                            tension: 0.4, pointRadius: 0, fill: false
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { maxTicksLimit: 12 } },
                        y: { title: { display: true, text: 'MW Capacity' }, min: 6000 }
                    },
                    plugins: { tooltip: { mode: 'index', intersect: false } }
                }
            });
            updateDuckCurve();
        }

        function saveScenario() {
            if (!suppressionChart20yr) {
                initSuppressionChart();
                updateSuppressionForecast('vre', 35);
                updateSuppressionForecast('fuel', 1.0);
                updateDisplacementTable();
            }
            const scenario = {
                year: currentYear, plant: currentPlant, delay: globalProjectDelay, rateAdj: geaRateAdjustment,
                vreP: document.getElementById('valVRE').innerText.replace('%', ''),
                fuelT: document.getElementById('valFuel').innerText.replace('x', ''),
                pshP: pshPenetration, geoP: geoPenetration, hydP: hydPenetration
            };
            const blob = new Blob([JSON.stringify(scenario, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `GEA3_Scenario_Export_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }

        function loadScenario(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.year) setYear(data.year);
                    if (data.plant) { document.getElementById('plantSelect').value = data.plant; updatePlant(); }
                    if (data.delay !== undefined) { document.getElementById('slideDelay').value = data.delay; updateStressParam('delay', data.delay); }
                    if (data.rateAdj !== undefined) { document.getElementById('slideRateAdj').value = data.rateAdj; updateStressParam('rateadj', data.rateAdj); }
                    if (data.vreP) { document.getElementById('slideVRE').value = data.vreP; updateSuppressionForecast('vre', data.vreP); }
                    if (data.fuelT) { document.getElementById('slideFuel').value = data.fuelT; updateSuppressionForecast('fuel', data.fuelT); }
                    if (data.pshP) { document.getElementById('slidePsh').value = data.pshP; updateSuppressionForecast('psh', data.pshP); }
                    if (data.geoP) { document.getElementById('slideGeo').value = data.geoP; updateSuppressionForecast('geo', data.geoP); }
                    if (data.hydP) { document.getElementById('slideHyd').value = data.hydP; updateSuppressionForecast('hyd', data.hydP); }
                } catch (err) { alert('Failed to parse JSON configuration: ' + err.message); console.error(err); }
            };
            reader.readAsText(file);
        }

        // Initialize Advanced Analytics
        updateDisplacementHeatmap();
        setInterval(updateDisplacementHeatmap, 5000);

        // Initialize Initial Content
        initRainChartGened();
        initDuckCurve();

        // Finalized Initialization
        populateTable();
        populateRoadmap('PSH');
        populateRoadmap('GEO');
        populateRoadmap('IMP');
        updatePlant();
        updateSensitivityChart();
    </script>
    </div>
</body>

</html>
